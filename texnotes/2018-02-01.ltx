\documentclass{article}
\input{theorem}
\input{prooftree}
\usepackage{stmaryrd}
\usepackage{latexsym}
\usepackage{yfonts}
\usepackage{amsmath}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{tikz}
\usetikzlibrary{calc,arrows,cd,decorations.pathreplacing}
\usetikzlibrary{decorations.pathmorphing}
\usepackage{tcolorbox}
\tcbuselibrary{breakable}

\def\ridp{\mathsf{idp}}
\def\fc{\mathfrak{C}}
\def\ff{\mathfrak{F}}
\def\ssem#1{\langle\!\langle{#1}\rangle\!\rangle}

\definecolor{cyan}{rgb}{0.80,0.95,0.95}
\definecolor{orange}{rgb}{0.95,0.90,0.80}
\definecolor{lred}{rgb}{0.95,0.8,0.8}
\definecolor{lgray}{gray}{0.9}
\newtcolorbox{declbox}{colframe=lred,colback=lred,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{thmbox}{colframe=cyan,colback=cyan,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{defnbox}{colframe=orange,colback=orange,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{tangentbox}{colframe=lgray,colback=lgray,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}

\input{linear}
\def\rpath#1{[#1]}
\def\rfst{\mathsf{fst}\,}
\def\rsnd{\mathsf{snd}\,}
\def\bunfold{\mathbf{unfold}}
\def\bfold{\mathbf{fold}}
\def\susp#1{\langle {#1} \rangle}
\def\ssusp#1{\langle\!\langle {#1} \rangle\!\rangle}
\def\dto{\mathrel{\dot\to}}
\def\dns{{\downarrow}}
\def\ups{{\uparrow}}
\def\sprov{\Vdash}
\def\signat{{\color{red}\Sigma}}

\def\wat{\mathbin{@}}
\def\wwat{\mathbin{\underline\wat}}
\def\cn{{:}}
\def\dv{{\div}}
\def\ww{{\mathsf w}}
\def\base{{\textfrak b}}

\def\N{{\mathbb N}}
\def\munit{I}
\def\tt{{\mathsf t}}
\def\rr{{\mathsf r}}
\def\ii{{\mathbb I}}
\def\pp{\textsf{\textbf p}}
\def\nn{{\mathsf n}}
\def\PP{\textsf{\textbf P}}
\def\NN{{\mathsf N}}
\def\zz{{\mathsf z}}
\def\sem#1{[\![#1]\!]}
\def\usem#1{\lceil\!\!\lceil{#1}\rceil\!\!\rceil}
\def\zem#1{\langle\!\langle#1\rangle\!\rangle}
\def\col#1{{\mathsf{C}}_{#1}}
\def\lax{\mathop\bigcirc}
\def\rjust{\mathsf{just}}
\def\rcvt{\mathsf{cvt}}
\def\rtype{\mathsf{type}}
\def\rkind{\mathsf{kind}}
\def\rmode{\mathsf{mode}}
\def\rprel{\mathbf{Prel}}
\def\rrfam{\mathbf{Rfam}}
\def\rset{\mathbf{Set}}
\def\rrel{\mathbf{Rel}}
\def\rcat{\mathbf{Cat}}
\def\rfam{\mathbf{Fam}}
\def\binj{\mathbf{inj}}
\def\rid{\mathsf{id}}
\def\rtrue{\mathrel\mathrm{true}}
\def\pbck{\ar[dr, phantom, pos=0, "\lrcorner"]}
\def\bpbck{\ar[ddrr, phantom, pos=0, "\lrcorner"]}
\def\erule#1#2{\begin{prooftree}#1\justifies #2\end{prooftree}}
\def\lpar{\bindnasrepma}
\def\lamp{\binampersand}
\def\btwo{\mathbf{2}}
\def\bone{\mathbf{1}}

\newarrow {Equiv} =====
\def\FinSet{\mathbf{FinSet}}
\def\x{\times}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\def\mapt{\ar[ddd,mapsto,shorten <=2em, shorten >=2em]}
\def\frommaps{\ar[from=uu,mapsto,shorten <=2em, shorten >=2em, crossing over]}
\def\frommapt{\ar[from=uuu,mapsto,shorten <=2em, shorten >=2em, crossing over]}
\def\C{\mathbf{C}}
\def\S{\mathbf{S}}
\def\D{\mathbf{D}}
\def\E{\mathbf{E}}
\def\M{\mathbf{M}}
\def\pair#1#2{\langle#1,#2\rangle}
\def\tri{\triangleright}
\def\o{\circ}
\def\rctx{\,\mathsf{ctx}}
\def\del{\partial}
\def\also#1{\ \textcolor{blue}{\celse #1}}
\newcounter{nodemaker}
\setcounter{nodemaker}{0}
\def\twocell#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift left=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift right=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\twocellswap#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift right=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift left=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\null{\emptyset}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\author{Jason Reed}
\definecolor{fib}{HTML}{ff7f00}
\definecolor{green}{HTML}{007f00}
\definecolor{red}{HTML}{df3f3f}
\definecolor{opfib}{HTML}{007fff}

% For lightening colors I used
% http://trycolors.com/ 6 parts white to 1 part color
\definecolor{opfibl}{HTML}{DBEDFF}
\definecolor{greenl}{HTML}{DBEDDB}
\definecolor{redl}{HTML}{FAE4E4}
\def\njudge#1{\fcolorbox{opfib}{white}{#1}}
\def\nrule#1{\fcolorbox{white}{opfibl}{#1}}
\def\neqn#1{\fcolorbox{white}{redl}{#1}}



\def\judge#1{\vskip 2em\noindent \njudge{$#1$}\vskip 0.5em\noindent}
\def\rule#1{\vskip 2em \noindent \nrule{$#1$}\vskip 0.5em\noindent}
\def\eqn#1{\vskip 2em \noindent \neqn{$#1$}\vskip 0.5em\noindent}
\def\prof{\nrightarrow}
\def\tensor{\otimes}
\def\htensor{\mathrel{\hat\otimes}}
\def\lol{\multimap}
\def\hlol{\mathrel{\hat\multimap}}
\def\wtf{{\color{red}???}}
\begin{document}

\def\
\tikzset{
   commutative diagrams/.cd,
   arrow style=tikz,
   diagrams={>=stealth}}
% got this from
% https://tex.stackexchange.com/questions/169512/tikz-style-arrow-tips-missing-when-using-tikz-cd-crossing-over
% ???

\section{Thinking about contexts and substitutions}
General convention for the whole document: assume $g : c \to d$ and $h : d \to e$.
\[ \Gamma = (x : A, y : B, z : C)\]
\[ \sem \Gamma_e = (x : \sem A_e, y : \sem B_e, z : \sem C_e) \]
I want to come up with a substitution
$\theta$
\[(x : \sem A_c, y : [\sem A_g(x)/x]\sem B_d, z : \theta \sem C_e)\]
is a valid context.
I know
\[ x : \sem A_e, y : \sem B_e \prov \sem C_e : \rtype \]
\[ x : \sem A_d, y : \sem B_d \prov \sem{x:A,y:B}_h \sem C_e : \rtype \]
\[ x : \sem A_c, y : \sem{x:A}_g\sem B_d \prov \sem{x:A}_g\sem{x:A,y:B}_h \sem C_e : \rtype \]
That seems to do the trick.

\subsection{Paging back in path stuff}
So let me declare
\[
\begin{tabular}{r@{$\quad$}c@{$\quad::=\quad$ }l}
  Paths&$\pi$&$\bullet_c \celse \pi ; g  $\\
\end{tabular}
\]
I can then define what it means to be a valid path in a context; I just need the lengths
to match up, and for the path to be valid.
\begin{declbox}
$\Gamma \prov \pi : \rpath c$
\end{declbox}
\begin{defnbox}
  $$
\erule
{}
{x : A \prov \bullet_c : \rpath c}
\qquad
\erule
{\Gamma \prov \pi : \rpath c\qquad g : c \to d}
{\Gamma, x : A \prov (\pi ; g) : \rpath d}
$$
\end{defnbox}
I can pick out the codomain of a path easily enough:
\begin{declbox}
  $\bar \pi $
\end{declbox}
\begin{defnbox}
\begin{tabular}{l@{ }c@{ }l}
 $\overline{\bullet_c}$&$=$&$c$\\
$\overline{ \pi ; g}$&$=$&$\cod g$
\end{tabular}
\end{defnbox}


Concretely futzing around some more I see something like


\[\Gamma_1 = x : A_1\]
\[\Gamma_4 = x_1 : A_1, x_2 : A_2, x_3 : A_3, x_4 : A_4\]
\[x_1 : \sem{A_1}_{c_4}, x_2 : \sem{A_2}_{c_4}, x_3 : \sem{A_3}_{c_4}, x_4 : \sem{A_4}_{c_4}\]
\[x_1 : \sem{A_1}_{c_3}, x_2 : \sem{A_2}_{c_3}, x_3 : \sem{A_3}_{c_3}, x_4 : \sem{\Gamma_3}_{g_{34}}\sem{A_4}_{c_4}\]
\[x_1 : \sem{A_1}_{c_1}, x_2 : \sem{\Gamma_1}_{g_{12}}\sem{A_2}_{c_2}, x_3 : \sem{\Gamma_1}_{g_{12}}\sem{\Gamma_2}_{g_{23}}\sem{A_3}_{c_3}, \]\[x_4 : \sem{\Gamma_1}_{g_{12}}\sem{\Gamma_2}_{g_{23}}\sem{\Gamma_3}_{g_{34}}\sem{A_4}_{c_4}\]

So I expect something like a substitution operation
\begin{declbox}
  $\sem \Gamma^\pi$
\end{declbox}
\begin{thmbox}
If $\Gamma \prov \pi : [c]$, then $\prov \sem {\Gamma}_{\pi} : \rctx$.\\
If $\Gamma \prov \pi : [c]$, then $\sem \Gamma_\pi \prov \sem {\Gamma}^{\pi;g} : \sem \Gamma_{d}$.
\end{thmbox}
\begin{defnbox}
\begin{tabular}{l@{ }c@{ }l}
 $\sem {x:A}_{\bullet_c}$&$=$&$x : \sem A_c$\\
$\sem{\Gamma, x : A}_{\pi;g}$&$=$&$\sem \Gamma_\pi, x : \sem \Gamma^{\pi;g} \sem A_{d}$
\end{tabular}\\\vskip 0.5em
\begin{tabular}{l@{ }c@{ }l}
 $\sem \cdot^{\bullet_c}$&$=$&$\rid$\\
\color{gray} $\sem {x : A}^{\bullet_c;g}$&\color{gray}$=$&\color{gray}$[\sem A_g(x) / x]$\\
$\sem{\Gamma, x : A}^{\pi;g}$&$=$&$\sem \Gamma^\pi \o \sem {\Gamma, x : A}_g $
\end{tabular}
\end{defnbox}
\begin{lemma}
If $\Gamma \prov \pi : [c]$, then $\prov \sem {\Gamma}_{\pi} : \rctx$.
\end{lemma}

\begin{proof}
If $\pi$ is $\bullet_c$, then $\Gamma = x : A$, and $ \prov A : \rtype$,
so $\prov \sem A_c : \rtype$. Otherwise, we need to show
$\prov \sem{\Gamma, x : A}_{\pi;g} : \rctx$.
We have ${\Gamma} \prov A : \rtype$ so $\sem {\Gamma}_d \prov \sem A_d : \rtype$,
hence by applying $\sem {\Gamma}^{\pi;g}$ we get
$\sem {\Gamma}^\pi \prov \sem {\Gamma}^{\pi;g} \sem A_d : \rtype$
as required.
\cqed
\end{proof}
\begin{lemma}
If $\Gamma \prov \pi : [c]$, then $\sem \Gamma_\pi \prov \sem {\Gamma}^{\pi;g} : \sem \Gamma_{d}$.
\end{lemma}

\begin{proof}
If $\pi = \bullet_c$ and $\Gamma = x : A$ we must show
\[x : \sem A_c \prov \sem A_g(x) :  \sem A_d\]
which holds. Otherwise we have to show
\[\sem {\Gamma, x : A}_{\pi;g} \prov \sem {\Gamma, x : A}^{\pi;g;h} : \sem {\Gamma, x : A}_{e}\]
i.e.
\[\sem {\Gamma}_\pi, x : \sem \Gamma^{\pi;g}\sem{A}_d \prov \sem\Gamma^{\pi;g} \o \sem {\Gamma, x : A}_h  : \sem {\Gamma}_e, x : \sem{A}_{e}\]
and we already know that
\[\sem {\Gamma, x : A}_d \prov \sem {\Gamma, x : A}_h \prov \sem {\Gamma, x : A}_e\]
so it remains to see that
\[\sem {\Gamma}_\pi, x : \sem \Gamma^{\pi;g}\sem{A}_d \prov \sem\Gamma^{\pi;g}   : (\sem {\Gamma}_d, x : \sem{A}_{d})\]
and this follows from the induction hypothesis.
\cqed
\end{proof}

\subsection{Trying to Shorten Definitions}

What if instead I say

\begin{defnbox}
\[
\erule
{}
{\cdot \prov \bullet_c : \rpath c}
\qquad
\erule
{\Gamma \prov \pi : \rpath c\qquad g : c \to d}
{\Gamma, x : A \prov (\pi ; g) : \rpath d}
\]
\vskip 1em
\begin{tabular}{l@{ }c@{ }l}
 $\zem {\cdot}_{\bullet_c}$&$=$&$\cdot$\\
$\zem{\Gamma, x : A}_{\pi;g}$&$=$&$\zem \Gamma_\pi, x : \sem \Gamma^{\pi} \sem A_{c}$
\end{tabular}
\vskip 1em
\begin{tabular}{l@{ }c@{ }l}
 $\sem \cdot^{\bullet_c}$&$=$&$\rid_{\cdot}$\\
$\sem{\Gamma, x : A}^{\pi;g}$&$=$&$ \sem \Gamma^\pi[x/x] \o \sem {\Gamma, x : A}_g $
\end{tabular}
\end{defnbox}

\begin{lemma}
\ \vskip 0.5em
\begin{thmbox}
1. If $\Gamma \prov \pi : [c]$, then $\prov \zem {\Gamma}_{\pi} : \rctx$.\\
2. If $\Gamma \prov \pi : [c]$, then $\zem \Gamma_{\pi} \prov \sem {\Gamma}^{\pi} : \sem \Gamma_{\bar\pi}$.
\end{thmbox}
\end{lemma}

\begin{proof}
\ \begin{enumerate}
\item Easy in the case where $\Gamma = \cdot$ and $\pi = \bullet_c$.
Otherwise we have $\Gamma \prov A : \rtype$ and we need
$\zem \Gamma_\pi \prov \sem \Gamma^{\pi} \sem A_c : \rtype$.
But by (2) we know \[\zem \Gamma_\pi \prov \sem \Gamma^{\pi} : \sem \Gamma_c\]
so just apply that substitution to $\sem \Gamma_c \prov \sem A_c : \rtype$.
\item Easy in the case where $\Gamma = \cdot$ and $\pi = \bullet_c$. Otherwise
we have $\Gamma, x : A$ and $\pi; g$ and we need to show
\[\zem {\Gamma,x:A}_{\pi;g} \prov \sem {\Gamma,x:A}^{\pi;g} : \sem {\Gamma,x:A}_{d}\]
i.e.
\[\zem {\Gamma}_\pi, x:\sem \Gamma^{\pi}\sem {A}_{c} \prov (\sem \Gamma^\pi[x/x]) \o \sem {\Gamma, x : A}_g : \sem {\Gamma,x:A}_{d}\]
We already know that
\[\sem {\Gamma, x : A}_c \prov  \sem {\Gamma, x : A}_g : \sem {\Gamma,x:A}_{d}\]
so it remains to verify that
\[\zem {\Gamma}_\pi, x:\sem \Gamma^{\pi}\sem {A}_{c} \prov \sem \Gamma^\pi[x/x]  : (\sem {\Gamma}_c ,x:\sem{A}_{c})\]
which follows from i.h. \cqed
\end{enumerate}


\end{proof}


\[\sem \Gamma^\pi[x/x] \o \sem{\Gamma, x :A}_g\]
\[=  (\sem\Gamma^\pi\o\sem{\Gamma}_g) [\sem\Gamma^\pi\sem{A}_g(x)/x]\]
\end{document}

% garbage
If $A : *$ then $\usem A : A \to *$
\[\pi : \Pi A \cn * . \Pi a \cn A .  \usem A\ a\]
\[\sem \pi : \pi \in \sem{\Pi A \cn * . \Pi a \cn A .  \usem A\ a}   \]
\[\sem \pi : \Pi A \cn * .\Pi \dot A \cn A \to * . \pi\ A \in \sem{ \Pi a \cn A .  \dot A\ a}   \]
\[\sem \pi : \Pi A \cn * .\Pi \dot A \cn A \to * .  \Pi a \cn A .  \Pi \dot a \cn \dot A(a) .\pi\ A \in \sem{  \dot A\ a}   \]
\[\sem \pi : \Pi A \cn * .\Pi \dot A \cn A \to * .  \Pi a \cn A .  \Pi \dot a \cn \dot A(a) .  \sem{  \dot A\ a} (\pi\ A)  \]
\[\sem \pi : \Pi A \cn * .\Pi \dot A \cn A \to * .  \Pi a \cn A .  \Pi \dot a \cn \dot A(a) . \sem {\dot A}\ a\ \sem a\ (\pi\ A)\]
\[\sem \pi : \Pi A \cn * .\Pi \dot A \cn A \to * .  \Pi a \cn A .  \Pi \dot a \cn \dot A(a) . \usem {\dot A}\ a\ \dot a\ (\pi\ A)\]
\[\sem{ \dot A} : \dot A \in \sem {A \to *}\]
\[\sem{ \dot A} : \Pi a \cn A . \Pi \dot a \cn \dot A(a) . \dot A(a) \to *\]


\end{document}
