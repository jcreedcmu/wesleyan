\documentclass{article}
\input{theorem}
\input{prooftree}
\usepackage{stmaryrd}
\usepackage{latexsym}
\usepackage{yfonts}
\usepackage{amsmath}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{tikz}
\usetikzlibrary{calc,arrows,cd,decorations.pathreplacing}
\usetikzlibrary{decorations.pathmorphing}
\usepackage{tcolorbox}
\tcbuselibrary{breakable}

\def\wo{\setminus}
\def\rarm{\mathsf{rarm}}
\def\embu{\mathsf{embu}}
\def\coglue{\mathsf{coglue}}
\def\el#1{\textcolor{bluegray}{\texttt{[}}{#1}\textcolor{bluegray}{\texttt{]}}}
\def\quote#1{{\ulcorner {#1} \urcorner}}
\def\U{\mathsf{U}}
\def\fA{\mathsf{A}}
\def\fC{\mathsf{C}}
\def\ff{\mathsf{f}}
\def\B{\mathsf{B}}
\def\uni{\U}
\def\mor#1#2{#1 \to \underline{#2}}
\def\atm#1{\underline{#1}}

\def\ridp{\mathsf{idp}}
\def\ssem#1{\langle\!\langle{#1}\rangle\!\rangle}

\definecolor{cyan}{rgb}{0.80,0.95,0.95}
\definecolor{orange}{rgb}{0.95,0.90,0.80}
\definecolor{lred}{rgb}{0.95,0.8,0.8}
\definecolor{bluegray}{rgb}{0.4,0.4,0.8}
\definecolor{lgray}{gray}{0.9}
\newtcolorbox{declbox}{colframe=lred,colback=lred,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{thmbox}{colframe=cyan,colback=cyan,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{defnbox}{colframe=orange,colback=orange,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt}
\newtcolorbox{tangentbox}{colframe=lgray,colback=lgray,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}

\input{linear}
\def\rpath#1{[#1]}
\def\rfst{\mathsf{fst}\,}
\def\rsnd{\mathsf{snd}\,}
\def\bunfold{\mathbf{unfold}}
\def\bfold{\mathbf{fold}}
\def\pbind#1{\langle {#1} \rangle}
\def\ppbind#1{\langle\!\langle {#1} \rangle\!\rangle}
\def\dto{\mathrel{\dot\to}}
\def\dns{{\downarrow}}
\def\ups{{\uparrow}}
\def\sprov{\Vdash}
\def\signat{{\color{red}\Sigma}}

\def\wat{\mathbin{@}}
\def\wwat{\mathbin{\underline\wat}}
\def\cn{{:}}
\def\dv{{\div}}
\def\ww{{\mathsf w}}
\def\base{{\textfrak b}}

\def\N{{\mathbb N}}
\def\munit{I}
\def\tt{{\mathsf t}}
\def\rr{{\mathsf r}}
\def\ii{{\mathbb I}}
\def\pp{\textsf{\textbf p}}
\def\nn{{\mathsf n}}
\def\PP{\textsf{\textbf P}}
\def\NN{{\mathsf N}}
\def\zz{{\mathsf z}}
\def\sem#1{[\![#1]\!]}
\def\usem#1{\lceil\!\!\lceil{#1}\rceil\!\!\rceil}
\def\zem#1{\langle\!\langle#1\rangle\!\rangle}
\def\col#1{{\mathsf{C}}_{#1}}
\def\lax{\mathop\bigcirc}
\def\rjust{\mathsf{just}}
\def\rcvt{\mathsf{cvt}}
\def\rtype{\mathsf{type}}
\def\rkind{\mathsf{kind}}
\def\rmode{\mathsf{mode}}
\def\rprel{\mathbf{Prel}}
\def\rrfam{\mathbf{Rfam}}
\def\rset{\mathbf{Set}}
\def\rfinset{\mathbf{FinSet}}
\def\rrel{\mathbf{Rel}}
\def\rcat{\mathbf{Cat}}
\def\rfam{\mathbf{Fam}}
\def\binj{\mathbf{inj}}
\def\rid{\mathsf{id}}
\def\rtrue{\mathrel\mathrm{true}}
\def\pbck{\ar[dr, phantom, pos=0, "\lrcorner"]}
\def\bpbck{\ar[ddrr, phantom, pos=0, "\lrcorner"]}
\def\erule#1#2{\begin{prooftree}#1\justifies #2\end{prooftree}}
\def\lpar{\bindnasrepma}
\def\lamp{\binampersand}
\def\btwo{\mathbf{2}}
\def\bone{\mathbf{1}}

\newarrow {Equiv} =====
\def\FinSet{\mathbf{FinSet}}
\def\x{\times}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\def\mapt{\ar[ddd,mapsto,shorten <=2em, shorten >=2em]}
\def\frommaps{\ar[from=uu,mapsto,shorten <=2em, shorten >=2em, crossing over]}
\def\frommapt{\ar[from=uuu,mapsto,shorten <=2em, shorten >=2em, crossing over]}
\def\C{\mathbf{C}}
\def\S{\mathbf{S}}
\def\D{\mathbf{D}}
\def\E{\mathbf{E}}
\def\M{\mathbf{M}}
\def\pair#1#2{\langle#1,#2\rangle}
\def\tri{\triangleright}
\def\o{\circ}
\def\rctx{\,\mathsf{ctx}}
\def\del{\partial}
\def\also#1{\ \textcolor{blue}{\celse #1}}
\newcounter{nodemaker}
\setcounter{nodemaker}{0}
\def\twocell#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift left=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift right=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\twocellswap#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift right=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift left=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\null{\emptyset}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\author{Jason Reed}
\definecolor{fib}{HTML}{ff7f00}
\definecolor{green}{HTML}{007f00}
\definecolor{red}{HTML}{df3f3f}
\definecolor{opfib}{HTML}{007fff}

% For lightening colors I used
% http://trycolors.com/ 6 parts white to 1 part color
\definecolor{opfibl}{HTML}{DBEDFF}
\definecolor{greenl}{HTML}{DBEDDB}
\definecolor{redl}{HTML}{FAE4E4}
\def\njudge#1{\fcolorbox{opfib}{white}{#1}}
\def\nrule#1{\fcolorbox{white}{opfibl}{#1}}
\def\neqn#1{\fcolorbox{white}{redl}{#1}}

\def\judge#1{\vskip 2em\noindent \njudge{$#1$}\vskip 0.5em\noindent}
\def\rule#1{\vskip 2em \noindent \nrule{$#1$}\vskip 0.5em\noindent}
\def\eqn#1{\vskip 2em \noindent \neqn{$#1$}\vskip 0.5em\noindent}

\def\tensor{\otimes}
\def\lol{\multimap}

\def\wtf{{\color{red}???}}

\def\zero{\texttt{0}}

\begin{document}

\def\
\tikzset{
   commutative diagrams/.cd,
   arrow style=tikz,
   diagrams={>=stealth}}
% got this from
% https://tex.stackexchange.com/questions/169512/tikz-style-arrow-tips-missing-when-using-tikz-cd-crossing-over
% ???


\section{A more Serious Problem}

I didn't really properly appreciate how the affine interval variables
interact with structural rules. There seem to be at least two obvious
possibilities for how to interpret weakening of types along an interval
variable.

We expect the rule
\[
\erule
{\Gamma \prov A : \rset}
{\Gamma, \nu : \sharp n \prov A^w : \rset}
\]
(writing $A^w$ as notation for weakened-$A$ for clarity in defining the semantics,
even though we'd actually just think of this as silently identical with $A$
in ordinary uses of the syntax)
to hold, but we could say either of the following two options, which
I'll call the
`exchange option'
\begin{defnbox}
  \begin{tabbing}
    \hspace*{2em}\=\hspace*{2em}\= \kill
    $\sem {A^w}_I (\rho, \nu := \atm k) = \sem A_{I}(\rho)$\\
    $\sem {A^w}_I (\rho, \nu := i) = \sem A_{I\wo i}(\rho)$
  \end{tabbing}
\end{defnbox}
and the `cellular option'
\begin{defnbox}
  \begin{tabbing}
    \hspace*{2em}\=\hspace*{2em}\= \kill
    $\sem {A^w}_I (\rho, \nu := \atm k) = \sem A_{I}(\rho)$\\
    $\sem {A^w}_I (\rho, \nu := i) = \sem A_{I}(\sem \Gamma_w(\rho))$
  \end{tabbing}
\end{defnbox}
where $w$ is the weakening substitution $I, i \prov w : I$.

\subsection{Argument In Favor of the Exchange Option}
The exchange option appears to be compatible with an exchange rule like
\[
\begin{prooftree}
  {\Gamma, x : A, \nu : \sharp n \prov J}
\Justifies
  {\Gamma, \nu : \sharp n, x : A^w  \prov J}
\end{prooftree}
\]
Because each inhabitant of
$\sem{\Gamma, x : A, \nu : \sharp n}_I$ looks like one of
\begin{tabbing}
  \hspace*{10em}\=\hspace*{2em}\= \kill
  $(\rho, x := a, \nu = \atm k)$ \> for $\rho\in\sem \Gamma_I$ and $a \in \sem A_I$\\
  $(\rho, x := a, \nu = i)$ \> for $\rho\in\sem \Gamma_{I\wo i}$ and $a \in \sem A_{I\wo i}$
\end{tabbing}
and the inhabitants of $\sem{\Gamma, \nu : \sharp n, x : A^w}$ look like
\begin{tabbing}
  \hspace*{10em}\=\hspace*{2em}\= \kill
  $(\rho, \nu = \atm k, x := a)$ \> for $\rho\in\sem \Gamma_I$ and $a \in \sem A_I$\\
  $(\rho, \nu = i, x := a)$ \> for $\rho\in\sem \Gamma_{I\wo i}$ and $a \in \sem A_{I\wo i}$
\end{tabbing}
This obvious equality doesn't hold with the cellular option.
\subsection{Argument In Favor of the Cellular Option}
The cellular option appears to be compatible with the idea that
functions of $\sharp n$ into a type correspond to cubical cells of the
type construed as a cubical set.

Suppose $\Gamma \prov A : \rset$.
%% Then we can think about
%% what $M$ satisfy
%% \[\Gamma, \nu : \sharp n \prov M : A^w\]
%% semantically, these will be functions
%% \[(\rho' : \sem {\Gamma, \nu : \sharp n}_I) \to \sem {A^w}_I(\rho')\]
%% so, assuming we're taking the cellular option, these have to map
%
%% \begin{tabbing}
%%   \hspace*{12em}\=\hspace*{2em}\= \kill
%%   $(\rho, \nu = \atm k) \mapsto \sem A_I(\rho)$ \> for $\rho\in\sem \Gamma_I$ \\
%%   $(\rho, \nu = i) \mapsto \sem A_I(\sem \Gamma_w(\rho))$ \> for $\rho\in\sem \Gamma_{I\wo i}$
%% \end{tabbing}
Then $\Gamma, \nu : \sharp n \prov A^w : \rset$, and
 $\Gamma \prov \forall \nu . A^w : \rset$. What is its interpretation?
\[\sem{\forall \nu . A^w}_I = \sem A^w_{I,i}(\rho, \nu := i)\]
\[ = \sem A_{I,i}(\sem \Gamma_w(\rho))\]
So it's a type whose points correspond to lines in $A$, whose lines correspond
to cubes in $A$, etc.

\subsection{Why Rejecting Exchange Might Be Ok}

Maybe I can interpret what I've been thinking of as $\sharp$-elimination as {\em the}
exchange rule. Its invertibility I think already follows from Moulin's \textsc{Surj-Fun}.
If I think of it as invertible, as a macro-expansion, then it's just giving the {\em meaning} of ordinary hypotheses to the right of affine hypotheses.

What I {\em mean} when I say $\Gamma, \nu : \sharp n, b : B \prov D$ is
that all of the following can be constructed:
\begin{tabbing}
  \hspace*{12em}\=\hspace*{2em}\= \kill
$\Gamma, k : n, b :[\atm k / \nu]B \prov e : [\atm k / \nu]D$\\
$\Gamma, b' : \forall \nu . B, \nu : \sharp n \prov e' : [b'\ \nu / b]D$\\
$[\atm k / \nu]e' \equiv [b'\ \atm k / b] e$
\end{tabbing}

Does the semantics of the latter line up with the `cellular'
interpretation of weakening? Let's first consider what happens when $B$ and $D$
do properly depend on $\nu$. The former supposes that I have an $M$
such that
\[\sem \bcase_I : (\rho : \sem {\Gamma, \nu : \sharp n, b : B}_I) \to \sem D_I(\rho\adjust_{\Gamma, \nu})\]
and here we are doing ordinary weakening of $D$ along $b : B$.

\subsection{What Is Surjectivity}
Recall that we're dealing with the rule
\[
\erule
{
\begin{tabular}{c}
$\Gamma, k : n, b :[\atm k / \nu]B \prov e : [\atm k / \nu]D$\\
$\Gamma, b' : \forall \nu . B, \nu : \sharp n \prov e' : [b'\ \nu / b]D$\\
$[\atm k / \nu]e' \equiv [b'\ \atm k / b] e$
\end{tabular}
}
{\Gamma, \nu : \sharp n, b : B \prov \bcase (\nu,b) \bof (\atm k,b).e \celse (b',\nu).e' : D}
\]
I want to think of this chiefly as a tuple of its branches $e$ and $e'$.
If I have $\Gamma, \nu : \sharp n, b : B \prov M : D$ there are two `projections'
I can take of it,
\[\Gamma, k : n, b : [\atm k / \nu]B \prov [\atm k / \nu]M : [\atm k / \nu]D\]
\[\Gamma,  b' : \forall \nu. B, \nu : \sharp n \prov [b'\ \nu / b]M : [b'\ \nu / b]D\]
So I want to demand a couple of $\beta$-laws
\[\bcase (\atm k,b) \bof (\atm k,b).e \celse (b',\nu).e' \equiv_\beta e\]
\[\bcase (\nu,b'\ \nu) \bof (\atm k,b).e \celse (b',\nu).e' \equiv_\beta e'\]
and an $\eta$-law
\[\bcase (\nu,b) \bof (\atm k,b).[\atm k/\nu]M \celse (b',\nu).[b'\ \nu/b]M \equiv_\eta M\]

\begin{defnbox}
  \begin{tabbing}
    \hspace*{2em}\=\hspace*{2em}\=\kill
    \(\sem {\bcase \cdots}_I : (\rho' : \sem {\Gamma, \nu : {\sharp n}, y : B}_I) \to
    \sem D_I(\rho')\)\\
    $\sem {\bcase \cdots}_I(\rho, \nu := \atm k, y := y) = \sem e_I(\rho, k := k, x := y)$\\
    $\sem {\bcase \cdots}_I(\rho, \nu := i, y := y) = \sem{e'}_I (\rho, x' := y, \nu := i)$
  \end{tabbing}
\end{defnbox}


\end{document}
