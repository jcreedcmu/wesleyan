\documentclass{article}
\usepackage{amssymb}
\input{theorem}

\input{prooftree}
\def\erule#1#2{\begin{prooftree}#1\justifies #2\end{prooftree}}

\usepackage{tikz}
\usepackage{tikz-cd}
\def\adjust{\big|}
\def\O{\mathcal{O}}
\def\rid{\mathsf{id}}
\def\int{\square}
\def\bd{\partial}
\def\prov{\vdash}
\def\prequiv{\dashv\vdash}
\def\imp{\Rightarrow}
\def\cqed{\hskip2mm{\vrule width .5em height .5em depth 0em}} % at the end of a |P.
\def\o{\circ}
\def\C{\mathbb{C}}
\def\R{\mathbb{R}}
\def\x{\times}
\def\st{\mathrel|}
\def\rset{\mathbf{Set}}
\def\op{\mathsf{op}}
\def\P{\mathbf{P}}
\def\dash{\hbox{---}}
\def\deg{\mathop{\mathsf{deg}}}
\def\celse{\mathrel{|}}
\def\cn{{:}}
\def\rok{\mathrel\mathsf{ok}}
\def\sub{\subseteq}

\title{Categorifying the BCH Formula}
\begin{document}
\maketitle
\tikzset{
   commutative diagrams/.cd,
   arrow style=tikz,
   diagrams={>=stealth}}
Given a groupoid $G$, its cardinality is defined as
\[|G| =  \sum_{X \in G/\sim} {1\over |\mathrm{Aut}(X)|}\]
A span of groupoids
\[
 \begin{tikzcd}
& G \ar[dl, "\alpha"']\ar[dr, "\beta"]\\
A && B
 \end{tikzcd}
\]
plays the role of a matrix. The $(a,b)$ entry of the matrix is the groupoid cardinality of the fiber over $(a,b)$.
A span where the two legs are equal
\[
 \begin{tikzcd}
& G \ar[dl]\ar[dr]\\
A && A
 \end{tikzcd}
\]
plays the role of a square matrix. Call it a {\em square span}. The product of matrices is represented by weak pullback of spans.
\[\begin{tikzcd}
    & & G  H \ar[dr] \ar[dl] \ar[dd, very near start, phantom, "{\hbox{\rotatebox{-45}{\Large$\lrcorner$}}}"] & & \\
    & G \ar[dl, "\alpha"'] \ar[dr, "\beta_1"] & & H \ar[dl, "\beta_2"'] \ar[dr, "\gamma"] & \\
    A & & B & & C \\
\end{tikzcd}\]
\def\gg{{\bf g}}
\def\hh{{\bf h}}
An object of $GH$ is a tuple $(g, h, b)$ where $g,h$ are objects of $G,H$ and $b$ is an isomorphism
$b : \beta_1 (g) \to \beta_2(h) \in B$. A morphism $(g,h,b) \to (g',h',b')$ in $GH$ is a pair of morphisms
$\gg : g \to g', \hh : h \to h'$ such that
\[\begin{tikzcd}
\beta_1 g \ar[r, "b"]\ar[d, "\beta_1 \gg"']& \beta_2 h\ar[d, "\beta_2\hh"]\\
\beta_1 g' \ar[r, "b'"']& \beta_2 h'
\end{tikzcd}\]

We can explicitly describe, the $n$th power of a square span
\[
 \begin{tikzcd}
& G \ar[dl, "\alpha"']\ar[dr, "\beta"]\\
A && A
 \end{tikzcd}
\]
as follows. An object of $G^n$ consists of
\begin{enumerate}
\item An $n$-tuple $\vec g = (g_1, \ldots, g_n)$ of objects of $G$.
\item An $(n-1)$-tuple $\vec a = (a_i : \beta(g_i) \to \alpha(g_{i+1}) \st i \in 1,\ldots,n-1)$ of isomorphisms in $A$.
\end{enumerate}
A morphism $(\vec g, \vec a) \to (\vec g', \vec a')$ is a tuple of morphisms $\vec \gg = (\gg_i : g_i \to g'_i)$
such that for every $i$ we have
\[\begin{tikzcd}
\beta g_i \ar[r, "a_i"]\ar[d, "\beta \gg_i"']& \alpha g_{i+1}\ar[d, "\alpha\gg_{i+1}"]\\
\beta g_i' \ar[r, "a_i'"']& \alpha g_{i+1}'
\end{tikzcd}\]
Now I want to try to describe the symmetric power $G^n/n!$.

 An object of $G^n/n!$ consists of
\begin{enumerate}
\item A permutation $\sigma : [n] \to [n]$.
\item An $n$-tuple $\vec g = (g_1, \ldots, g_n)$ of objects of $G$.
\item An $(n-1)$-tuple $\vec a = (a_i : \beta(g_{\sigma i}) \to \alpha(g_{\sigma(i+1)}) \st i \in 1,\ldots,n-1)$ of isomorphisms in $A$.
\end{enumerate}
A morphism $(\sigma, \vec g, \vec a) \to (\sigma', \vec g', \vec a')$ is a tuple of morphisms $\vec \gg = (\gg_{ i} : g_{\sigma i} \to g'_{\sigma' i})$
such that for every $i$ we have
\[\begin{tikzcd}
\beta g_{\sigma i} \ar[r, "a_{ i}"]\ar[d, "\beta \gg_i"']& \alpha g_{\sigma(i+1)}\ar[d, "\alpha\gg_{i+1}"]\\
\beta g_{\sigma'i}' \ar[r, "a_{i}'"']& \alpha g_{\sigma'(i+1)}'
\end{tikzcd}\]
This doesn't seem quite right

\subsection{Groupoid Quotients Generally}
Let $G$ be a groupoid and $H$ be a group, considered as a one-object groupoid.
Suppose we have an action which is a functor $H \to {\mathrm Aut}(G)$, meaning
that the action of every $\eta\in H$ is a functor $G \to G$. We define
the quotient $G // H$ by saying an object in it is an object of $G$, and a
morphism in $\hom_{G // H}(A, B)$ is a tuple $(\eta, f)$ where $\eta \in H$
and $f : A \to \eta B$ in $G$. We need to say how to compose $f : A \to \eta B$ and
$g : B \to \gamma C$. We hit $g$ with the functor $\eta$ to get $\eta g : \eta B \to \eta \gamma C$.
Then we define
\[(\gamma, g) \o (\eta, f) = (\eta \gamma, \eta g \o f)  \]
Then we should be able to prove $|G//H| = |G| / |H|$. Or really I guess if I view $H$ as a 1-object groupoid rather than a group,
I'd be proving $|G//H| = |G| |H|$. In any case, I've blown up every homset uniformly by a factor of $|H|$, so this should be
true.

\subsection{Easy Special Case}
Let's suppose $[X,[X,Y]] = [Y,[X,Y]] = 0$, so that
\[ e^X e^Y = e^{X + Y + [X,Y]/2}\]
Set $L = [X,Y]/2$. That means we're assuming $XL = LX$ and $YL = LY$.
Let's expand both sides of the equation $e^X e^Y = e^{X+Y+L}$ and see what we get.
The left is
\[ (1 + X + X^2/2! + X^3/3! + \cdots)(1 + Y + Y^2/2! + Y^3/3! + \cdots)  \]
\[ = 1 + (X + Y)\]
\[ + (X^2/2! + XY + Y^2/2!)\]
\[ + (X^3/3! + X^2Y/2! + XY^2/2! + Y^3/3!)\]
\[ + (X^4/4! + X^3Y/3! + X^2Y^2/2!2! + XY^3/3! + Y^4/4!)\]
\[ + \cdots\]
The right is
\[ (1 + X + Y + L + (X + Y + L)^2/2! + (X + Y + L)^3/3! + \cdots)\]
\[ = 1 + (X + Y) \]
\[ + L + (X^2 + XY + YX + Y^2)/2! \]
\[ + XL + YL + (X^3 + X^2Y + XYX + XY^2 + YX^2 + YXY + Y^2X + Y^3)/3! \]
\[ + (X^2 + XY + YX + Y^2)L/2! + L^2/2!\]
\[ + (X^4 + X^3Y + X^2YX + X^2Y^2 + XYX^2 + XYXY + XY^2X + XY^3 \]
\[ + YX^3 + YX^2Y + YXYX + YXY^2 + Y^2X^2 + Y^2XY + Y^3X + Y^4)/4! + \cdots \]
So I want to hope for some kind of isomorphism $L + (XY + YX)/2 \cong XY$.
This would let me reconcile the order-2 terms. For the order-3 terms I need to show
\[ (X+Y)L + (X^2Y + XYX + XY^2 + YX^2 + YXY + Y^2X)/3! = X^2Y/2! + XY^2/2!\]
or
\[ 6(X+Y)L +  XYX + Y^2X + YX^2 + YXY = 2X^2Y + 2XY^2\]
and I know
\[2L + XY + YX = 2XY\]
which would give me
\[2XL + X^2Y + XYX = 2X^2Y\]
\[2YL + YXY + Y^2X = 2YXY\]
\[2XL + XYX + YX^2 = 2XYX\]
\[2YL + XY^2 + YXY = 2XY^2\]
so using the middle two equations I can reduce my goal to
\[ 4(X+Y)L +  2XYX +  2YXY = 2X^2Y + 2XY^2\]
and using the outer two twice each I can establish this --- but only by using negatives.
Maybe I really want something more like
\[2L + YX = XY\]
?

\subsection{The Commutative Equivalence}
Suppose $X$ and $Y$ are groupoids rather than spans. Then in what sense is it the case that
\[ e^X e^Y = e^{X+Y} \]
holds? Observe that an object in the latter is some mixed sequence of objects from $X$ and $Y$,
e.g.
\[ x_1x_5y_1x_3y_1y_2y_1x_9 \]
and a morphism is some wiring diagram of morphisms from $X \cup Y$ to some other sequence like
that. We can filter this into a pair of sequences $ x_1x_5x_3x_9 $ and $ y_1y_1y_2y_1 $ and it
will be possible to filter
the wiring diagrams accordingly because the coproduct of groupoids guarantees there will be no $x \to y$ wires.
This constitutes a functor from $e^{X+Y}$ to $e^X e^Y$.

This seems like it should extend to a pair of commuting spans.
To be clearer about the meaning of the factorials in the quotients, I could let the exponential
take a groupoid parameter $Q$ as well as the span itself:
\[ \exp(X, Q) = 1 + QX + {Q^2\over 2!}X^2 + {Q^3\over 3!} X^3 + \cdots \]
So then how do I reconcile \[ \exp(X, Q) \exp (Y, Q) = \exp(X + Y, Q)\]
when it happens to be the case that $X, Y$ commute? We need to construct a functor from
$\exp(X + Y, Q)$ to $\exp(X, Q) \exp (Y, Q)$. On the input side we effectively
have a {\em path} that we need to untangle. Each step comes from $X$ or $Y$.
We assume we have an isomorphism of spans $XY \cong YX$. So we swap around steps
until we have all $X$s on the left and all $Y$s on the right. We move the corresponding $Q$s
around in parallel. Now we have an object of $\exp(X, Q) \exp (Y, Q)$.

$\ldots$ or do we? I don't know the wiring of the
$Q$s splits into distinct $X$ and $Y$ chunks.

\subsection{Unifying the last two thoughts}

Let's axiomatize just enough of formal noncommutative power series to get the job done.
We have a single `scalar' variable $q$, and operator-valued variables $X, Y, L, \ldots$.
 We have an associative noncommutative algebra on the operators,
so that $XY$ generally is not $YX$, but $qX = Xq$. We

We write $\lambda$ for a composition, i.e. a sequence $\lambda_1, \ldots, \lambda_k$ with $\lambda_i \ge 1$ summing to $n$.
We write $(\lambda + 1)$ to mean $\lambda_1+1, \ldots, \lambda_k+1$ when $\lambda = \lambda_1,\ldots,\lambda_k$.
The notation ${n \choose \lambda }$ is the usual definition of multinomial coefficient for the sequence
$\lambda$. We define
\[D^\lambda f = \prod_i  (D^{\lambda_i})f\]
We can then define an operation of extracting the $n$th derivative at zero $D^n f = (d/dq)^n f \adjust_{q=0}$.
We require every exponential $e^f$ to factor as $e^{qf_0}$.
\[ D^n (fg) = \sum_{i+j = n} {n \choose i} (D^if)(D^j g) \]
\[ D^n e^{qf} = \sum_{\lambda + 1 \prov n}{n \choose \lambda} D^{\lambda} f  \]
\[ D^n q = \cases{1 & if $n=1$;\cr 0 & otherwise.}\]
\[ D^n C = 0 \qquad (q\not\in C)\]


So I want to assume $XY = YX + 2L$ and try to show
\[ D^n(e^{qX} e^{qY})  \stackrel{?}{=} D^n(e^{q(X + Y + qL)})\]
The $n=0$ case is showing $1=1$. The $n=1$ case is showing
\[ X + Y  = D(qX + qY + q^2L) = X+Y\]
The $n=2$ case involves the compositions of 2. There are two of them,
1+1 and 2. We conclude
\[ D^2 e^{qf} = (D^0 f)^2 + 2D^1 f\]
so specifically we need
\[ X^2 + 2XY + Y^2 {=} (X+Y)^2 + 2L\]
which we can accomplish with $XY = YX + 2L$.

Let's try $n=3$. Generally,
\[ D^3 e^{qf} = f^3 + 3 ff' + 3f'f + 3f''\]

We need to show
\[ D^3(e^{qX} e^{qY})  = D^3(e^{q(X + Y + qL)})\]
\[ X^3 + 3X^2Y + 3XY^2 + Y^3  = (X + Y)^3 + 3(X+Y)L + 3L(X+Y)\]
which reduces to showing
\[  3X^2Y + 3XY^2  =  XXY + XYX + XYY + YXX + YXY + YYX + 3(X+Y)L + 3L(X+Y)\]
and then, if we have $LX = XL$ and $LY = YL$, we can reason our way towards
\[  3X^2Y + 3XY^2  =  2XXY + XYY + YXX + YXY + YXY + (X+Y)L + 3L(X+Y)\]
\[  3X^2Y + 3XY^2  =  2XXY + 2XYY + XYX + YXY + (X+Y)L + L(X+Y)\]
\[  3X^2Y + 3XY^2  =  2XXY + 2XYY + XYX + YXY + 2XL + 2LY\]
\[  3X^2Y + 3XY^2  =  3XXY + 3XYY \]

Let's just try to see where the $n=4$ case is going.  Generally,
\[ D^4 e^{qf} = f^4 +  4 f'ff + 4ff'f + 4fff' + 12ff'' + 12f''f + 12f' f' + 4 f''' \]
and so specifically (using commutativity)
\[ (X^4 + 4X^3Y + 6X^2Y^2 + 4XY^3 + Y^4) = (X+Y)^4 +  12L(X+Y)^2 + 12L^2 \]
So if I move all the $X$s and $Y$s on the lhs to general position, I get to
\[ (X + Y)^4 + 12LX^2 + 12LY^2 + 18LXY + 6LYX \]
so I need only show that
\[ 18LXY + 6LYX = 12LXY + 12LYX + 12L^2\]
but $XY = YX + 2L$ times $6L$ is exactly the $6LXY = 6LYX + 12L^2$ I need.

\subsection{ The $1/12$ terms}
Suppose we have operators $X, Y, L, M, N$ such that
\[\begin{array}{l}
2L + YX = XY\\
6M + LX = XL\\
6N + YL = LY\\
XM = MX \qquad YM = MY\\
XN = NX \qquad YN = NY
\end{array}\]
Then for all $n$,
\[ D^n(e^{qX} e^{qY})  = D^n(e^{q(X + Y + qL + q^2M + q^2N)})\]
analogous to saying
\[ e^{X} e^{Y}  = e^{X + Y + [X,Y]/2 + [X,[X,Y]]/12 + [[X,Y],Y]/12}\]
Let's look at the $n=3$ case. On the left we have
\[ X^3 + 3X^2Y + 3XY^2 + Y^3 \]
and on the right we use
\[ D^3 e^{qf} = f^3 + 3 ff' + 3f'f + 3f''\]
to see that our goal is
\[ (X + Y)^3 + 3(X + Y)L + 3L(X + Y) + 6M + 6N\]
Starting from the left, we can expand some of the $XY$s to get to
\[ (X + Y)^3 + 4XL + 2LX + 4LY + 2YL\]
and then we can expand an $XL$ to $6M + LX$ to get
\[ (X + Y)^3 + 3XL + 3LX + 4LY + 2YL + 6M\]
and an $LY$ to $6N + YL$ to get
\[ (X + Y)^3 + 3XL + 3LX + 3LY + 3YL + 6M + 6N\]
as required.
\end{document}
