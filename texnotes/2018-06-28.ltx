\documentclass{article}
\usepackage[tmargin=0.05in, bmargin=0.05in]{geometry}
\input{theorem}
\input{prooftree}
\usepackage{stmaryrd}
\usepackage{latexsym}
\usepackage{yfonts}
\usepackage{amsmath}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{tikz}
\usetikzlibrary{calc,arrows,cd,decorations.pathreplacing}
\usetikzlibrary{decorations.pathmorphing}
\usepackage{tcolorbox}
\tcbuselibrary{breakable}
\usepackage{listings}
\lstset{basicstyle=\ttfamily\footnotesize,breaklines=true}

\def\gol{\sqsubset}
\def\gor{\sqsupset}

\def\sp{\bullet}
\def\ot{\leftarrow}
\def\prequiv{\dashv\vdash}
\def\fdom{{\mathbf{d}f}}
\def\fcod{{\mathbf{e}f}}
\def\fidom{\mathbf{\bar d}f}
\def\ficod{\mathbf{\bar e}f}

\def\thn{\mathrel|}
\def\coe{\mathsf{coe}}
\def\bpush{\mathbf{push}}
\def\bpull{\mathbf{pull}}

\def\wo{\setminus}
\def\fA{\mathsf{A}}
\def\fC{\mathsf{C}}
\def\fX{\mathsf{X}}
\def\ff{\mathsf{f}}
\def\fm{\mathsf{m}}
\def\rspan{\mathsf{Span}}
% \def\El#1{\mathsf{El}({#1})}
\def\El#1{\ulcorner{#1}\urcorner}
\def\U{\mathsf{U}}
\def\uu{\mathsf{u}}
\def\uni{\U}
\def\mor#1#2{#1 \to \underline{#2}}

\def\ridp{\mathsf{idp}}
\def\ssem#1{\langle\!\langle{#1}\rangle\!\rangle}

\definecolor{lred}{rgb}{0.95,0.8,0.8}
\definecolor{cyan}{rgb}{0.80,0.95,0.95}
\definecolor{orange}{rgb}{0.95,0.90,0.80}
\definecolor{bluegray}{rgb}{0.6,0.6,0.85}
\definecolor{lgray}{gray}{0.9}
\newtcolorbox{declbox}{colframe=lred,colback=lred,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{thmbox}{colframe=cyan,colback=cyan,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{defnbox}{colframe=orange,colback=orange,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{tangentbox}{colframe=lgray,colback=lgray,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}

\input{linear}
\def\rpath#1{[#1]}
\def\rfst{\mathsf{fst}\,}
\def\rsnd{\mathsf{snd}\,}
\def\bunfold{\mathbf{unfold}}
\def\bfold{\mathbf{fold}}
\def\susp#1{\langle {#1} \rangle}
\def\ssusp#1{\langle\!\langle {#1} \rangle\!\rangle}
\def\dto{\mathrel{\dot\to}}
\def\dns{{\downarrow}}
\def\ups{{\uparrow}}
\def\sprov{\Vdash}
\def\signat{{\color{red}\Sigma}}
\def\ep#1{\underline{#1}}
\def\wat{\mathbin{@}}
\def\wwat{\mathbin{\underline\wat}}
\def\cn{{:}}
\def\dv{{\div}}
\def\ww{{\mathsf w}}
\def\base{{\textfrak b}}

\def\munit{I}
\def\tt{{\mathsf t}}
\def\ii{{\mathbb I}}
\def\T{\mathbb{T}}
\def\TP{\mathbf{TPre}}
\def\pp{\textsf{\textbf p}}
\def\nn{{\mathsf n}}
\def\PP{\textsf{\textbf P}}
\def\NN{\textsf{\textbf N}}
\def\zz{{\mathsf z}}
\def\sem#1{[\![#1]\!]}
\def\usem#1{\lceil\!\!\lceil{#1}\rceil\!\!\rceil}
\def\zem#1{\langle\!\langle#1\rangle\!\rangle}
\def\col#1{{\mathsf{C}}_{#1}}
\def\lax{\mathop\bigcirc}
\def\rjust{\mathsf{just}}
\def\rcvt{\mathsf{cvt}}
\def\rtype{\mathsf{type}}
\def\rdtype{\mathsf{disc}}
\def\rkind{\mathsf{kind}}
\def\rmode{\mathsf{mode}}
\def\rprel{\mathbf{Prel}}
\def\rrfam{\mathbf{Rfam}}
\def\rset{\mathbf{Set}}
\def\rfinset{\mathbf{FinSet}}
\def\rrel{\mathbf{Rel}}
\def\rcat{\mathbf{Cat}}
\def\rfam{\mathbf{Fam}}
\def\binj{\mathbf{inj}}
\def\rid{\mathsf{id}}
\def\rtrue{\mathrel\mathrm{true}}
\def\pbck{\ar[dr, phantom, pos=0, "\lrcorner"]}
\def\bpbck{\ar[ddrr, phantom, pos=0, "\lrcorner"]}
\def\erule#1#2{\begin{prooftree}#1\justifies #2\end{prooftree}}
\def\lpar{\bindnasrepma}
\def\lamp{\binampersand}
\def\btwo{\mathbf{2}}
\def\bone{\mathbf{1}}

\newarrow {Equiv} =====
\def\FinSet{\mathbf{FinSet}}
\def\x{\times}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\def\mapt{\ar[ddd,mapsto,shorten <=2em, shorten >=2em]}
\def\A{\mathbf{A}}
\def\B{\mathbf{B}}
\def\C{\mathbf{C}}
\def\G{\mathbf{G}}
\def\D{\mathbf{D}}
\def\DD{\mathbb{D}}
\def\E{\mathbf{E}}
\def\M{\mathbf{M}}
\def\pair#1#2{\langle#1,#2\rangle}
\def\ltri{{\lhd}}
\def\rtri{{\rhd}}
\def\tri{\rhd}
\def\ll{{<}}
\def\rr{{>}}
\def\cc{\mathsf{c}}
\def\dd{\mathsf{d}}
\def\o{\circ}
\def\rctx{\,\mathsf{ctx}}
\def\rdctx{\,\mathsf{dctx}}
\def\del{\partial}
\def\also#1{\ \textcolor{blue}{\celse #1}}
\newcounter{nodemaker}
\setcounter{nodemaker}{0}
\def\twocell#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift left=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift right=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\twocellswap#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift right=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift left=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\author{Jason Reed}
\definecolor{fib}{HTML}{ff7f00}
\definecolor{green}{HTML}{007f00}
\definecolor{red}{HTML}{df3f3f}
\definecolor{opfib}{HTML}{007fff}

% For lightening colors I used
% http://trycolors.com/ 6 parts white to 1 part color
\definecolor{opfibl}{HTML}{DBEDFF}
\definecolor{greenl}{HTML}{DBEDDB}
\definecolor{redl}{HTML}{FAE4E4}
\def\njudge#1{\fcolorbox{opfib}{white}{#1}}
\def\nrule#1{\fcolorbox{white}{opfibl}{#1}}
\def\neqn#1{\fcolorbox{white}{redl}{#1}}



\def\judge#1{\vskip 2em\noindent \njudge{$#1$}\vskip 0.5em\noindent}
\def\rule#1{\vskip 2em \noindent \nrule{$#1$}\vskip 0.5em\noindent}
\def\eqn#1{\vskip 2em \noindent \neqn{$#1$}\vskip 0.5em\noindent}
\def\prof{\nrightarrow}
\def\tensor{\otimes}
\def\htensor{\mathrel{\hat\otimes}}
\def\lol{\multimap}
\def\hlol{\mathrel{\hat\multimap}}
\def\wtf{{\color{red}???}}

\def\re{\mathbf{E}}
\def\sh{\sharp}
\def\shp{\mathrel{\sharp}}
\def\zero{\texttt{0}}
\begin{document}

\def\
\tikzset{
   commutative diagrams/.cd,
   arrow style=tikz,
   diagrams={>=stealth}}


\section{Sketching Out How I'd Like Things To Work}


\subsection{Polarized Ends}
Suppose $F, G : {}^{\C^\op}_{\x\C}   \to \rset$.

An inhabitant of the negative end
\[ \int_{c\in\Delta}  [F^c_c] \to G^c_c\]
consists of a family of functions
\[M_{f} : F^d_e \to G^d_e\]
for each morphism $f : d \to e \in \Delta$
such that
\[
\begin{tikzcd}
  F^d_d \ar[r, "{M_{\rid_d}}"] \ar[d, "F_f"'] & G^d_d \ar[d, "G_f"]\\
  F^d_e \ar[r, "{M_{f}}"']  & G^d_e\\
  F^e_e \ar[r, "{M_{\rid_e}}"'] \ar[u, "F^f"] & G^e_e \ar[u, "G^f"']
\end{tikzcd}
\]

An inhabitant of the positive end
\[ \int_{c\in\Delta}  F^c_c \to [G^c_c]\]
consists of a family of functions
\[M_{f} : F^e_d \to G^e_d\]
for each morphism $f : d \to e \in \Delta$
such that
\[
\begin{tikzcd}
  F^d_d \ar[r, "{M_{\rid_d}}"] \ar[from=d, "F^f"] & G^d_d \ar[from=d, "G^f"']\\
  F^e_d \ar[r, "{M_{f}}"']  & G^e_d\\
  F^e_e \ar[r, "{M_{\rid_e}}"'] \ar[from=u, "F_f"'] & G^e_e \ar[from=u, "G_f"]
\end{tikzcd}
\]

\subsection{Intended Semantics}
The interpretation of an unfocused sequent
\[\Delta;\Gamma \prov M : Q \]
should be an inhabitant of the end
\[M \in \int_{c\in\Delta} \Gamma^c_c \to Q^c_c\]
The interpretation of a left focus
\[\Delta;\Gamma[x : N] \prov M : Q \]
should be an inhabitant of the negative end
\[M \in \int_{c\in\Delta}  [N^c_c] \to (\Gamma \to Q)^c_c\]
The interpretation of a right focus
\[\Delta;\Gamma \prov [M : P] \]
should be an inhabitant of the positive end
\[M \in \int_{c\in\Delta} \Gamma^c_c \to [P^c_c]\]

\subsection{Caveat}
I think the `for each morphism $f : d\to e \in \Delta$' quantification is really
only over the subset of $\Delta$ that has been so far subject to synchronous quantifier rules.

\subsection{Trying To Validate Various Inference Rules}
\subsubsection{Implies Left}
\[
\erule
{\Gamma \prov [P] \qquad \Gamma [N] \prov Q}
{\Gamma [P \lol N] \prov Q}
\]
So we want to achieve
\[\erule{
M : \int_c \Gamma^c_c \to [P^c_c]
\qquad
K : \int_c  [N^c_c] \to (\Gamma \to Q)^c_c
}
{
L : \int_c  [(P \to N)^c_c] \to (\Gamma \to Q)^c_c
}\]
i.e.
\[\erule
{
M_f : \Gamma^e_d \to P^e_d
\qquad
K_f :   N^d_e \to \Gamma^e_d \to Q^d_e}
{
L_f : (P^e_d \to N^d_e) \to (\Gamma^e_d \to Q^d_e)
} \]
We least define $L_f (q) = \lambda g . K_f(q(M_f(g)), g)$. The diagrams we know for $M$ and $K$ are
\[
\begin{tikzcd}
  \Gamma^d_d \ar[r, "{M_{d}}"] \ar[from=d, "\Gamma^f"] & P^d_d \ar[from=d, "P^f"']\\
  \Gamma^e_d \ar[r, "{M_{f}}"']  & P^e_d\\
  \Gamma^e_e \ar[r, "{M_{e}}"'] \ar[from=u, "\Gamma_f"'] & P^e_e \ar[from=u, "P_f"]
\end{tikzcd}
\qquad
\begin{tikzcd}
  N^d_d \ar[r, "{K_{d}}"] \ar[d, "N_f"'] & {(\Gamma\to Q)}^d_d \ar[d, "{(\Gamma\to Q)}_f"]\\
  N^d_e \ar[r, "{K_{f}}"']  & {(\Gamma\to Q)}^d_e\\
  N^e_e \ar[r, "{K_{e}}"'] \ar[u, "N^f"] & {(\Gamma\to Q)}^e_e \ar[u, "{(\Gamma\to Q)}^f"']
\end{tikzcd}
\]
and we want to check
\[
\begin{tikzcd}
  (P \to N)^d_d \ar[r, "{L_{d}}"] \ar[d, "(P \to N)_f"'] & {(\Gamma\to Q)}^d_d \ar[d, "{(\Gamma\to Q)}_f"]\\
  (P \to N)^d_e \ar[r, "{L_{f}}"']  & {(\Gamma\to Q)}^d_e\\
  (P \to N)^e_e \ar[r, "{L_{e}}"'] \ar[u, "(P \to N)^f"] & {(\Gamma\to Q)}^e_e \ar[u, "{(\Gamma\to Q)}^f"']
\end{tikzcd}
\]
Maybe this is easier to do algebraically than diagrammatically. The top half of the
$N$-diagram is saying that for any $n \in N^d_d, g \in \Gamma^e_d$, we have
\[K_f(N_f n, g) = Q_f K_d(n, \Gamma^f g)\]

Then checking
the top half of the bottom diagram, we let $z \in P^d_d \to N^d_d$ be given,
and reason
\[ L_f (P \to N)_f z = L_f (N_f \o z \o P^f) \]
\[ = \lambda g . K_f(((N_f \o z \o P^f))(M_f(g)), g) \]
\[ = \lambda g . K_f(N_f  z  P^fM_fg, g) \]
\[ = \lambda g . Q_f K_d(  z  P^fM_fg, \Gamma^f g) \]
\[ = \lambda g . Q_f K_d(  z  M_d \Gamma^f g, \Gamma^f g) \]
\[ = Q_f \o (L_d ( z)) \o \Gamma^f\]
\[ = (\Gamma \to Q)_f (L_d ( z)) \]
and checking the bottom parts of the diagrams is symmetric.

\subsubsection{Forall Left}
\[
\erule
{ \Gamma [[t/\alpha]N] \prov Q \qquad \Delta \prov t : \C}
{\Gamma [\forall \alpha . N] \prov Q}
\]
So we want to achieve something like
\[\erule{
M :  \int_c [N^{cb}_{cb}]^{\theta[t^c_c/b]} \to (\Gamma \to Q)^c_c
}
{
L : \int_c  \left[\int_b N^{cb}_{cb}\right]^\theta \to (\Gamma \to Q)^c_c
}\]
in which I am making up some notation, imagining that the focus positions
are parametrized by substitutions.

What is this supposed to do semantically? We should
first of all have
$t : {}^{\Delta^\op}_{\x \Delta} \to \C$. The domain of $\theta$ --- the variables
it's substituting for --- should be some subset of the variables being quantified
over when we say $\int_{c\in\Delta}$.

Actually, let me rewrite this a bit:
\[\erule{
M :  \int_{d\in\Delta} [N^{dxc}_{dxc}]^{\theta[t^{dx}_{dx}/c]}_{x,c\in \Xi \x \C} \to (\Gamma \to Q)^{d}_{d}
}
{
L : \int_{d\in \Delta}  \left[\int_{c\in \C} N^{dxc}_{dxc}\right]_{x \in \Xi}^\theta \to (\Gamma \to Q)^{d}_{d}
}\]

I'm trying to conceive of a negative-focused-end-thing as
\[\int_{d\in \Delta}  [F^{dx}_{dx}]_{x \in \Xi}^\theta \to G^{d}_{d} \]
where $\theta$ is a substitution $\Delta \prov \theta : \Xi$.
An inhabitant of it is, for every $f : d \to e$ and $\xi : x \to y$,

\[M_{f\xi} : F^{d\theta(x)}_{e\theta(y)} \to G^{d}_{e} \]
Such that for any $f$,
\[
\begin{tikzcd}
  F^{d\theta(x)}_{d\theta(x)} \ar[r, "{M_{\rid_d}}"] \ar[d, "F_{f\theta(\xi)}"'] & G^d_d \ar[d, "G_f"]\\
  F^{d\theta(x)}_{e\theta(y)} \ar[r, "{M_{f \xi}}"']  & G^d_e\\
  F^e_e \ar[r, "{M_{\rid_e}}"'] \ar[u, "F^f"] & G^e_e \ar[u, "G^f"']
\end{tikzcd}
\]
Oof giant notational headache I'm not even going to finish making that diagram correct
until I pause and think a bit.

\def\inn#1{\underline{#1}}
\def\doub{\Delta^2}
What is $\theta$, semantically? A functor from $\Xi$ to $\Delta$. Let's make some notation
that's a little more uniform. A negative end looks like
\[\int_{d\in \Delta}  [F^{d\inn d}_{d\inn d}]_{\inn d \in \inn \Delta}^\theta \to G^{d}_{d} \]
for $\Delta$ and $\inn \Delta$ categories, and $\theta : \inn \Delta \to \Delta$. An inhabitant
of it is, for any morphism $f : d \to e \in \Delta$, and $\inn f : \inn d \to \inn e \in \inn \Delta$,
\[M_{f\inn f} : F^{d\theta_{\inn d}}_{e\theta_{\inn e}} \to G^{d}_{e} \]
Maybe an easier way of talking about this is to define $\doub  = \Delta \x \inn\Delta$, and
let $\pi : \doub \to \Delta$ be the first projection, and say that the meaning
of
\[\int_{d\in \doub}  [F^{d}_{d}]^\theta \to G^{\pi d}_{\pi d} \]
is an inhabitant, for every $f : d \to e \in \doub$,
...
wait, some type discipline is breaking down. Shoot.
What is the type of $F$ supposed to be? Maybe I need to do some
smaller examples before I generalize.

\subsubsection{Forall Left With Two Variables}
Let's say I want to model
\[
\erule
{\alpha : \A; [[t/\beta] F] \prov G \qquad \alpha : \A \prov t : \B}
{\alpha : \A;  [\forall (\beta:\B) . F]\prov G}
\]
Then I want
\[ F : {}^{\A^\op}_{\x \A} \x {}^{\B^\op}_{\x \B} \to \rset\]
\[ G :  {}^{\B^\op}_{\x \B} \to \rset\]
\[ t :  {}^{\A^\op}_{\x \A} \to \B\]
The proof $\alpha : \A; [[t/\beta] F] \prov G$ is modelled as,
for every morphism $f : d \to e \in \A$, a map
\[ M_f : F^{dt^e_d}_{et^d_e} \to G^d_e \]
such that
\[
\begin{tikzcd}
  F^{d t^d_d}_{dt^d_d} \ar[r, "F^{t^f}_{ft_f}"]\ar[d, "M_d"']
& F^{d t^e_d}_{et^d_e} \ar[d, "M_f"]
& \ar[l]\ar[d, "M_e"] F^{e t^e_e}_{et^e_e}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]
The proof goal
$\alpha : \A;  [\forall (\beta:\B) . F]\prov G$ is modelled as,
for every $f : d \to e \in \A$, a map
\[ P_f : \left(\int_{\beta\in \B} F^{d\beta}_{e\beta}\right) \to G^d_e \]
such that
\[
\begin{tikzcd}
  \int_\beta F^{d \beta}_{d \beta} \ar[r]\ar[d, "P_d"']
& \int_\beta F^{d \beta}_{e\beta} \ar[d, "P_f"]
& \ar[l]\ar[d, "P_e"] \int_\beta F^{e \beta}_{e\beta}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]
So we attempt to set
\[ P_f (w) = M_f ( F_{ t^f_f } w_{t^e_d} )\]
and remembering that $w$'s end property means
\[F_{ t^f_f } w_{t^e_d} = F^{ t^f_f } w_{t^d_e}\]
we try to verify, for any $x \in \int_\beta F^{d\beta}_{d\beta}$, that
$P_f(\int_\beta F_f) x = G_f P_d x$, which means
\[M_f ( F_{ t^f_f } ((\int_\beta F_f) x)_{t^e_d}   = G_f M_d (  x_{t^d_d} )\]
so we reason
\[M_f ( F_{ t^f_f } ((\int_\beta F_f) x)_{t^e_d} = M_f ( F_{ t^f_f } ( F_f x_{t^e_d})) \]
(noting that $x_{t^e_d} : F^{dt^e_d}_{dt^e_d}$, so $F_{t^f_f} F_f x_{t^e_d} : F^{dt^e_d}_{et^d_e}$)
\[ = M_f  F_f  F_{t_f} F_{ t^f}  x_{t^e_d} \]
(by the end-property of $x$ we have)
\[ = M_f  F_f  F_{t_f} F^{ t^f}  x_{t^d_d} \]
(and by the negative-end-property of $M$ we have)
\[ = G_f M_d    x_{t^d_d} \]
Yeah, that seems fine!

\subsection{Another Pass at Nailing Down General Polarized Ends}

Ok, if I have two categories $\A$ and $\B$, and functors
\[ F : {}^{\A^\op}_{\x \A} \x {}^{\B^\op}_{\x \B} \to \rset\]
\[ G :  {}^{\B^\op}_{\x \B} \to \rset\]
\[ \theta :  {}^{\A^\op}_{\x \A} \to \B\]
then a negative end is written
\[\int_\beta [ F^{\alpha\beta}_{\alpha\beta}]^\theta_\alpha \to G^\beta_\beta \]
and what it means is for every $f : d \to e \in \A$, there's a map
\[M_f : F^{d\theta^e_d}_{e\theta^d_e} \to G^d_e\]
such that
\[
\begin{tikzcd}
  F^{d \theta^d_d}_{d\theta^d_d} \ar[r]\ar[d, "M_d"']
& F^{d \theta^e_d}_{e\theta^d_e} \ar[d, "M_f"]
& \ar[l]\ar[d, "M_e"] F^{e \theta^e_e}_{e\theta^e_e}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]

A positive end is written
\[\int_\beta  G^\beta_\beta \to [F^{\alpha\beta}_{\alpha\beta}]^\theta_\alpha \]
and what it means is for every $f : d \to e \in \A$, there's a map
\[M_f : G^d_e \to F^{d\theta^e_d}_{e\theta^d_e} \]
such that
\[
\begin{tikzcd}
  G^d_d \ar[d, "M_d"']\ar[from=r]
& G^d_e\ar[d, "M_f"]
 & \ar[from=l] G^e_e\ar[d, "M_e"]
\\
  F^{d \theta^d_d}_{d\theta^d_d} \ar[from=r]
& F^{d \theta^e_d}_{e\theta^d_e}
& \ar[from=l] F^{e \theta^e_e}_{e\theta^e_e}
\end{tikzcd}
\]
I do believe it is just a negative end, but in $\rset^\op$.
\end{document}
