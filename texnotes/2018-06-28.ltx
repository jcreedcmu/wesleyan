\documentclass{article}
\usepackage[tmargin=0.05in, bmargin=0.05in]{geometry}
\input{theorem}
\input{prooftree}
\usepackage{stmaryrd}
\usepackage{latexsym}
\usepackage{yfonts}
\usepackage{amsmath}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{tikz}
\usetikzlibrary{calc,arrows,cd,decorations.pathreplacing}
\usetikzlibrary{decorations.pathmorphing}
\usepackage{tcolorbox}
\tcbuselibrary{breakable}
\usepackage{listings}
\lstset{basicstyle=\ttfamily\footnotesize,breaklines=true}

\def\gol{\sqsubset}
\def\gor{\sqsupset}

\def\sp{\bullet}
\def\ot{\leftarrow}
\def\prequiv{\dashv\vdash}
\def\fdom{{\mathbf{d}f}}
\def\fcod{{\mathbf{e}f}}
\def\fidom{\mathbf{\bar d}f}
\def\ficod{\mathbf{\bar e}f}

\def\thn{\mathrel|}
\def\coe{\mathsf{coe}}
\def\bpush{\mathbf{push}}
\def\bpull{\mathbf{pull}}

\def\wo{\setminus}
\def\fA{\mathsf{A}}
\def\fC{\mathsf{C}}
\def\fX{\mathsf{X}}
\def\ff{\mathsf{f}}
\def\fm{\mathsf{m}}
\def\rspan{\mathsf{Span}}
% \def\El#1{\mathsf{El}({#1})}
\def\El#1{\ulcorner{#1}\urcorner}
\def\U{\mathsf{U}}
\def\uu{\mathsf{u}}
\def\uni{\U}
\def\mor#1#2{#1 \to \underline{#2}}

\def\ridp{\mathsf{idp}}
\def\ssem#1{\langle\!\langle{#1}\rangle\!\rangle}

\definecolor{lred}{rgb}{0.95,0.8,0.8}
\definecolor{cyan}{rgb}{0.80,0.95,0.95}
\definecolor{orange}{rgb}{0.95,0.90,0.80}
\definecolor{bluegray}{rgb}{0.6,0.6,0.85}
\definecolor{lgray}{gray}{0.9}
\newtcolorbox{declbox}{colframe=lred,colback=lred,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{thmbox}{colframe=cyan,colback=cyan,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{defnbox}{colframe=orange,colback=orange,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}
\newtcolorbox{tangentbox}{colframe=lgray,colback=lgray,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}

\input{linear}
\def\rpath#1{[#1]}
\def\rfst{\mathsf{fst}\,}
\def\rsnd{\mathsf{snd}\,}
\def\bunfold{\mathbf{unfold}}
\def\bfold{\mathbf{fold}}
\def\susp#1{\langle {#1} \rangle}
\def\ssusp#1{\langle\!\langle {#1} \rangle\!\rangle}
\def\dto{\mathrel{\dot\to}}
\def\dns{{\downarrow}}
\def\ups{{\uparrow}}
\def\sprov{\Vdash}
\def\signat{{\color{red}\Sigma}}
\def\ep#1{\underline{#1}}
\def\wat{\mathbin{@}}
\def\wwat{\mathbin{\underline\wat}}
\def\cn{{:}}
\def\dv{{\div}}
\def\ww{{\mathsf w}}
\def\base{{\textfrak b}}

\def\munit{I}
\def\tt{{\mathsf t}}
\def\ii{{\mathbb I}}
\def\T{\mathbb{T}}
\def\TP{\mathbf{TPre}}
\def\pp{\textsf{\textbf p}}
\def\nn{{\mathsf n}}
\def\PP{\textsf{\textbf P}}
\def\NN{\textsf{\textbf N}}
\def\zz{{\mathsf z}}
\def\sem#1{[\![#1]\!]}
\def\usem#1{\lceil\!\!\lceil{#1}\rceil\!\!\rceil}
\def\zem#1{\langle\!\langle#1\rangle\!\rangle}
\def\col#1{{\mathsf{C}}_{#1}}
\def\lax{\mathop\bigcirc}
\def\rjust{\mathsf{just}}
\def\rcvt{\mathsf{cvt}}
\def\rtype{\mathsf{type}}
\def\rdtype{\mathsf{disc}}
\def\rkind{\mathsf{kind}}
\def\rmode{\mathsf{mode}}
\def\rprel{\mathbf{Prel}}
\def\rrfam{\mathbf{Rfam}}
\def\rset{\mathbf{Set}}
\def\rfinset{\mathbf{FinSet}}
\def\rrel{\mathbf{Rel}}
\def\rcat{\mathbf{Cat}}
\def\rfam{\mathbf{Fam}}
\def\binj{\mathbf{inj}}
\def\rid{\mathsf{id}}
\def\rtrue{\mathrel\mathrm{true}}
\def\pbck{\ar[dr, phantom, pos=0, "\lrcorner"]}
\def\bpbck{\ar[ddrr, phantom, pos=0, "\lrcorner"]}
\def\erule#1#2{\begin{prooftree}#1\justifies #2\end{prooftree}}
\def\lpar{\bindnasrepma}
\def\lamp{\binampersand}
\def\btwo{\mathbf{2}}
\def\bone{\mathbf{1}}

\newarrow {Equiv} =====
\def\FinSet{\mathbf{FinSet}}
\def\x{\times}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\def\mapt{\ar[ddd,mapsto,shorten <=2em, shorten >=2em]}
\def\A{\mathbf{A}}
\def\B{\mathbf{B}}
\def\C{\mathbf{C}}
\def\G{\mathbf{G}}
\def\D{\mathbf{D}}
\def\DD{\mathbb{D}}
\def\E{\mathbf{E}}
\def\M{\mathbf{M}}
\def\pair#1#2{\langle#1,#2\rangle}
\def\ltri{{\lhd}}
\def\rtri{{\rhd}}
\def\tri{\rhd}
\def\ll{{<}}
\def\rr{{>}}
\def\cc{\mathsf{c}}
\def\dd{\mathsf{d}}
\def\o{\circ}
\def\rctx{\,\mathsf{ctx}}
\def\rdctx{\,\mathsf{dctx}}
\def\del{\partial}
\def\also#1{\ \textcolor{blue}{\celse #1}}
\newcounter{nodemaker}
\setcounter{nodemaker}{0}
\def\twocell#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift left=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift right=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\twocellswap#1#2{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#1,phantom,shift right=3,""{name=\mynodeone}]%
  \ar[#1,phantom,shift left=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,#2,from=\mynodeone,to=\mynodetwo]%
}
\def\maps{\ar[dd,mapsto,shorten <=2em, shorten >=2em]}
\author{Jason Reed}
\definecolor{fib}{HTML}{ff7f00}
\definecolor{green}{HTML}{007f00}
\definecolor{red}{HTML}{df3f3f}
\definecolor{opfib}{HTML}{007fff}

% For lightening colors I used
% http://trycolors.com/ 6 parts white to 1 part color
\definecolor{opfibl}{HTML}{DBEDFF}
\definecolor{greenl}{HTML}{DBEDDB}
\definecolor{redl}{HTML}{FAE4E4}
\def\njudge#1{\fcolorbox{opfib}{white}{#1}}
\def\nrule#1{\fcolorbox{white}{opfibl}{#1}}
\def\neqn#1{\fcolorbox{white}{redl}{#1}}



\def\judge#1{\vskip 2em\noindent \njudge{$#1$}\vskip 0.5em\noindent}
\def\rule#1{\vskip 2em \noindent \nrule{$#1$}\vskip 0.5em\noindent}
\def\eqn#1{\vskip 2em \noindent \neqn{$#1$}\vskip 0.5em\noindent}
\def\prof{\nrightarrow}
\def\tensor{\otimes}
\def\htensor{\mathrel{\hat\otimes}}
\def\lol{\multimap}
\def\hlol{\mathrel{\hat\multimap}}
\def\wtf{{\color{red}???}}

\def\re{\mathbf{E}}
\def\sh{\sharp}
\def\shp{\mathrel{\sharp}}
\def\zero{\texttt{0}}
\begin{document}

\def\
\tikzset{
   commutative diagrams/.cd,
   arrow style=tikz,
   diagrams={>=stealth}}


\section{Sketching Out How I'd Like Things To Work}


\subsection{Polarized Ends}
Suppose $F, G : {}^{\C^\op}_{\x\C}   \to \rset$.

An inhabitant of the negative end
\[ \int_{c\in\Delta}  [F^c_c] \to G^c_c\]
consists of a family of functions
\[M_{f} : F^d_e \to G^d_e\]
for each morphism $f : d \to e \in \Delta$
such that
\[
\begin{tikzcd}
  F^d_d \ar[r, "{M_{\rid_d}}"] \ar[d, "F_f"'] & G^d_d \ar[d, "G_f"]\\
  F^d_e \ar[r, "{M_{f}}"']  & G^d_e\\
  F^e_e \ar[r, "{M_{\rid_e}}"'] \ar[u, "F^f"] & G^e_e \ar[u, "G^f"']
\end{tikzcd}
\]

An inhabitant of the positive end
\[ \int_{c\in\Delta}  F^c_c \to [G^c_c]\]
consists of a family of functions
\[M_{f} : F^e_d \to G^e_d\]
for each morphism $f : d \to e \in \Delta$
such that
\[
\begin{tikzcd}
  F^d_d \ar[r, "{M_{\rid_d}}"] \ar[from=d, "F^f"] & G^d_d \ar[from=d, "G^f"']\\
  F^e_d \ar[r, "{M_{f}}"']  & G^e_d\\
  F^e_e \ar[r, "{M_{\rid_e}}"'] \ar[from=u, "F_f"'] & G^e_e \ar[from=u, "G_f"]
\end{tikzcd}
\]

\subsection{Intended Semantics}
The interpretation of an unfocused sequent
\[\Delta;\Gamma \prov M : Q \]
should be an inhabitant of the end
\[M \in \int_{c\in\Delta} \Gamma^c_c \to Q^c_c\]
The interpretation of a left focus
\[\Delta;\Gamma[x : N] \prov M : Q \]
should be an inhabitant of the negative end
\[M \in \int_{c\in\Delta}  [N^c_c] \to (\Gamma \to Q)^c_c\]
The interpretation of a right focus
\[\Delta;\Gamma \prov [M : P] \]
should be an inhabitant of the positive end
\[M \in \int_{c\in\Delta} \Gamma^c_c \to [P^c_c]\]

\subsection{Caveat}
I think the `for each morphism $f : d\to e \in \Delta$' quantification is really
only over the subset of $\Delta$ that has been so far subject to synchronous quantifier rules.

\subsection{Trying To Validate Various Inference Rules}
\subsubsection{Implies Left}
\[
\erule
{\Gamma \prov [P] \qquad \Gamma [N] \prov Q}
{\Gamma [P \lol N] \prov Q}
\]
So we want to achieve
\[\erule{
M : \int_c \Gamma^c_c \to [P^c_c]
\qquad
K : \int_c  [N^c_c] \to (\Gamma \to Q)^c_c
}
{
L : \int_c  [(P \to N)^c_c] \to (\Gamma \to Q)^c_c
}\]
i.e.
\[\erule
{
M_f : \Gamma^e_d \to P^e_d
\qquad
K_f :   N^d_e \to \Gamma^e_d \to Q^d_e}
{
L_f : (P^e_d \to N^d_e) \to (\Gamma^e_d \to Q^d_e)
} \]
We least define $L_f (q) = \lambda g . K_f(q(M_f(g)), g)$. The diagrams we know for $M$ and $K$ are
\[
\begin{tikzcd}
  \Gamma^d_d \ar[r, "{M_{d}}"] \ar[from=d, "\Gamma^f"] & P^d_d \ar[from=d, "P^f"']\\
  \Gamma^e_d \ar[r, "{M_{f}}"']  & P^e_d\\
  \Gamma^e_e \ar[r, "{M_{e}}"'] \ar[from=u, "\Gamma_f"'] & P^e_e \ar[from=u, "P_f"]
\end{tikzcd}
\qquad
\begin{tikzcd}
  N^d_d \ar[r, "{K_{d}}"] \ar[d, "N_f"'] & {(\Gamma\to Q)}^d_d \ar[d, "{(\Gamma\to Q)}_f"]\\
  N^d_e \ar[r, "{K_{f}}"']  & {(\Gamma\to Q)}^d_e\\
  N^e_e \ar[r, "{K_{e}}"'] \ar[u, "N^f"] & {(\Gamma\to Q)}^e_e \ar[u, "{(\Gamma\to Q)}^f"']
\end{tikzcd}
\]
and we want to check
\[
\begin{tikzcd}
  (P \to N)^d_d \ar[r, "{L_{d}}"] \ar[d, "(P \to N)_f"'] & {(\Gamma\to Q)}^d_d \ar[d, "{(\Gamma\to Q)}_f"]\\
  (P \to N)^d_e \ar[r, "{L_{f}}"']  & {(\Gamma\to Q)}^d_e\\
  (P \to N)^e_e \ar[r, "{L_{e}}"'] \ar[u, "(P \to N)^f"] & {(\Gamma\to Q)}^e_e \ar[u, "{(\Gamma\to Q)}^f"']
\end{tikzcd}
\]
Maybe this is easier to do algebraically than diagrammatically. The top half of the
$N$-diagram is saying that for any $n \in N^d_d, g \in \Gamma^e_d$, we have
\[K_f(N_f n, g) = Q_f K_d(n, \Gamma^f g)\]

Then checking
the top half of the bottom diagram, we let $z \in P^d_d \to N^d_d$ be given,
and reason
\[ L_f (P \to N)_f z = L_f (N_f \o z \o P^f) \]
\[ = \lambda g . K_f(((N_f \o z \o P^f))(M_f(g)), g) \]
\[ = \lambda g . K_f(N_f  z  P^fM_fg, g) \]
\[ = \lambda g . Q_f K_d(  z  P^fM_fg, \Gamma^f g) \]
\[ = \lambda g . Q_f K_d(  z  M_d \Gamma^f g, \Gamma^f g) \]
\[ = Q_f \o (L_d ( z)) \o \Gamma^f\]
\[ = (\Gamma \to Q)_f (L_d ( z)) \]
and checking the bottom parts of the diagrams is symmetric.

\subsubsection{Forall Left}
\[
\erule
{ \Gamma [[t/\alpha]N] \prov Q \qquad \Delta \prov t : \C}
{\Gamma [\forall \alpha . N] \prov Q}
\]
So we want to achieve something like
\[\erule{
M :  \int_c [N^{cb}_{cb}]^{\theta[t^c_c/b]} \to (\Gamma \to Q)^c_c
}
{
L : \int_c  \left[\int_b N^{cb}_{cb}\right]^\theta \to (\Gamma \to Q)^c_c
}\]
in which I am making up some notation, imagining that the focus positions
are parametrized by substitutions.

What is this supposed to do semantically? We should
first of all have
$t : {}^{\Delta^\op}_{\x \Delta} \to \C$. The domain of $\theta$ --- the variables
it's substituting for --- should be some subset of the variables being quantified
over when we say $\int_{c\in\Delta}$.

Actually, let me rewrite this a bit:
\[\erule{
M :  \int_{d\in\Delta} [N^{dxc}_{dxc}]^{\theta[t^{dx}_{dx}/c]}_{x,c\in \Xi \x \C} \to (\Gamma \to Q)^{d}_{d}
}
{
L : \int_{d\in \Delta}  \left[\int_{c\in \C} N^{dxc}_{dxc}\right]_{x \in \Xi}^\theta \to (\Gamma \to Q)^{d}_{d}
}\]

I'm trying to conceive of a negative-focused-end-thing as
\[\int_{d\in \Delta}  [F^{dx}_{dx}]_{x \in \Xi}^\theta \to G^{d}_{d} \]
where $\theta$ is a substitution $\Delta \prov \theta : \Xi$.
An inhabitant of it is, for every $f : d \to e$ and $\xi : x \to y$,

\[M_{f\xi} : F^{d\theta(x)}_{e\theta(y)} \to G^{d}_{e} \]
Such that for any $f$,
\[
\begin{tikzcd}
  F^{d\theta(x)}_{d\theta(x)} \ar[r, "{M_{\rid_d}}"] \ar[d, "F_{f\theta(\xi)}"'] & G^d_d \ar[d, "G_f"]\\
  F^{d\theta(x)}_{e\theta(y)} \ar[r, "{M_{f \xi}}"']  & G^d_e\\
  F^e_e \ar[r, "{M_{\rid_e}}"'] \ar[u, "F^f"] & G^e_e \ar[u, "G^f"']
\end{tikzcd}
\]
Oof giant notational headache I'm not even going to finish making that diagram correct
until I pause and think a bit.

\def\inn#1{\underline{#1}}
\def\doub{\Delta^2}
What is $\theta$, semantically? A functor from $\Xi$ to $\Delta$. Let's make some notation
that's a little more uniform. A negative end looks like
\[\int_{d\in \Delta}  [F^{d\inn d}_{d\inn d}]_{\inn d \in \inn \Delta}^\theta \to G^{d}_{d} \]
for $\Delta$ and $\inn \Delta$ categories, and $\theta : \inn \Delta \to \Delta$. An inhabitant
of it is, for any morphism $f : d \to e \in \Delta$, and $\inn f : \inn d \to \inn e \in \inn \Delta$,
\[M_{f\inn f} : F^{d\theta_{\inn d}}_{e\theta_{\inn e}} \to G^{d}_{e} \]
Maybe an easier way of talking about this is to define $\doub  = \Delta \x \inn\Delta$, and
let $\pi : \doub \to \Delta$ be the first projection, and say that the meaning
of
\[\int_{d\in \doub}  [F^{d}_{d}]^\theta \to G^{\pi d}_{\pi d} \]
is an inhabitant, for every $f : d \to e \in \doub$,
...
wait, some type discipline is breaking down. Shoot.
What is the type of $F$ supposed to be? Maybe I need to do some
smaller examples before I generalize.

\subsubsection{Forall Left With Two Variables}
\label{two.variables}
Let's say I want to model
\[
\erule
{\alpha : \A; [[t/\beta] F] \prov G \qquad \alpha : \A \prov t : \B}
{\alpha : \A;  [\forall (\beta:\B) . F]\prov G}
\]
Then I want
\[ F : {}^{\A^\op}_{\x \A} \x {}^{\B^\op}_{\x \B} \to \rset\]
\[ G :  {}^{\A^\op}_{\x \A} \to \rset\]
\[ t :  {}^{\A^\op}_{\x \A} \to \B\]
The proof $\alpha : \A; [[t/\beta] F] \prov G$ is modelled as,
for every morphism $f : d \to e \in \A$, a map
\[ M_f : F^{dt^e_d}_{et^d_e} \to G^d_e \]
such that
\[
\begin{tikzcd}
  F^{d t^d_d}_{dt^d_d} \ar[r, "F^{t^f}_{ft_f}"]\ar[d, "M_d"']
& F^{d t^e_d}_{et^d_e} \ar[d, "M_f"]
& \ar[l]\ar[d, "M_e"] F^{e t^e_e}_{et^e_e}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]
The proof goal
$\alpha : \A;  [\forall (\beta:\B) . F]\prov G$ is modelled as,
for every $f : d \to e \in \A$, a map
\[ P_f : \left(\int_{\beta\in \B} F^{d\beta}_{e\beta}\right) \to G^d_e \]
such that
\[
\begin{tikzcd}
  \int_\beta F^{d \beta}_{d \beta} \ar[r]\ar[d, "P_d"']
& \int_\beta F^{d \beta}_{e\beta} \ar[d, "P_f"]
& \ar[l]\ar[d, "P_e"] \int_\beta F^{e \beta}_{e\beta}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]
So we attempt to set
\[ P_f (w) = M_f ( F_{ t^f_f } w_{t^e_d} )\]
and remembering that $w$'s end property means
\[F_{ t^f_f } w_{t^e_d} = F^{ t^f_f } w_{t^d_e}\]
we try to verify, for any $x \in \int_\beta F^{d\beta}_{d\beta}$, that
$P_f(\int_\beta F_f) x = G_f P_d x$, which means
\[M_f ( F_{ t^f_f } ((\int_\beta F_f) x)_{t^e_d}   = G_f M_d (  x_{t^d_d} )\]
so we reason
\[M_f ( F_{ t^f_f } ((\int_\beta F_f) x)_{t^e_d} = M_f ( F_{ t^f_f } ( F_f x_{t^e_d})) \]
(noting that $x_{t^e_d} : F^{dt^e_d}_{dt^e_d}$, so $F_{t^f_f} F_f x_{t^e_d} : F^{dt^e_d}_{et^d_e}$)
\[ = M_f  F_f  F_{t_f} F_{ t^f}  x_{t^e_d} \]
(by the end-property of $x$ we have)
\[ = M_f  F_f  F_{t_f} F^{ t^f}  x_{t^d_d} \]
(and by the negative-end-property of $M$ we have)
\[ = G_f M_d    x_{t^d_d} \]
Yeah, that seems fine!

\subsection{Another Pass at Nailing Down General Polarized Ends}

Ok, if I have two categories $\A$ and $\B$, and functors
\[ F : {}^{\A^\op}_{\x \A} \x {}^{\B^\op}_{\x \B} \to \rset\]
\[ G :  {}^{\A^\op}_{\x \A} \to \rset\]
\[ \theta :  {}^{\A^\op}_{\x \A} \to \B\]
then a negative end is written
\[\int_\alpha [ F^{\alpha\beta}_{\alpha\beta}]^\theta_\beta \to G^\alpha_\alpha \]
and what it means is for every $f : d \to e \in \A$, there's a map
\[M_f : F^{d\theta^e_d}_{e\theta^d_e} \to G^d_e\]
such that
\[
\begin{tikzcd}
  F^{d \theta^d_d}_{d\theta^d_d} \ar[r]\ar[d, "M_d"']
& F^{d \theta^e_d}_{e\theta^d_e} \ar[d, "M_f"]
& \ar[l]\ar[d, "M_e"] F^{e \theta^e_e}_{e\theta^e_e}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]

A positive end is written
\[\int_\alpha  G^\alpha_\alpha \to [F^{\alpha\beta}_{\alpha\beta}]^\theta_\beta \]
and what it means is for every $f : d \to e \in \A$, there's a map
\[M_f : G^e_d \to F^{e\theta^d_e}_{d\theta^e_d} \]
such that
\[
\begin{tikzcd}
  G^d_d \ar[d, "M_d"']\ar[from=r]
& G^e_d\ar[d, "M_f"]
 & \ar[from=l] G^e_e\ar[d, "M_e"]
\\
  F^{d \theta^d_d}_{d\theta^d_d} \ar[from=r]
& F^{e \theta^d_e}_{d\theta^e_d}
& \ar[from=l] F^{e \theta^e_e}_{e\theta^e_e}
\end{tikzcd}
\]
I do believe it is just a negative end, but when we consider instead $\A^\op$, $\B^\op$,
and $\rset^\op$.
\subsection{Some Ideas For Better notation}
I could write $\theta F : {}^{\A^\op}_{\x \A} \to \rset$ defined by
\[(\theta F)^d_e = F^{d\theta^e_d}_{e\theta^d_e}\]
in which case a negative end would just be a map
\[M_f : (\theta F)^{d}_{e} \to G^d_e\]
such that
\[
\begin{tikzcd}
  (\theta F)^{d}_{d} \ar[r]\ar[d, "M_d"']
& (\theta F)^{d }_{e} \ar[d, "M_f"]
& \ar[l]\ar[d, "M_e"] (\theta F)^{e }_{e}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]
Ok, that's a great factorization, then, I can take as my fundamental definitions of positive and
negative end things that don't involve $\theta$s at all.

If I have
two functors $F,  G :  {}^{\A^\op}_{\x \A} \to \C$ then a negative end is written
\[\int_\alpha  [F^{\alpha}_{\alpha}] \to G^\alpha_\alpha \]
and consists of, for any $f : d \to e \in \A$, a family of $\C$-morphisms
\[
M_f : F^d_e \to G^d_e
\]
such that
\[
\begin{tikzcd}
  F^{d}_{d} \ar[r]\ar[d, "M_d"']
& F^{d }_{e} \ar[d, "M_f"]
& \ar[l]\ar[d, "M_e"] F^{e }_{e}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]
and a positive end is written
\[\int_\alpha  G^{\alpha}_{\alpha} \to [F^\alpha_\alpha] \]
and consists of
\[
M_f : G^e_d \to F^e_d
\]
such that
\[
\begin{tikzcd}
  G^{d}_{d} \ar[from=r]\ar[d, "M_d"']
& G^{e}_{d} \ar[d, "M_f"]
& \ar[from=l]\ar[d, "M_e"] G^{e }_{e}\\
  F^d_d \ar[from=r] & F^e_d & \ar[from=l] F^e_e
\end{tikzcd}
\]
And I then conclude the duality
\[M_f \in \int_{\alpha \in \A} G^\alpha_\alpha \to [F^\alpha_\alpha] : \C
\quad\longleftrightarrow\quad
M_f \in \int_{\alpha \in \A^\op} [F^\alpha_\alpha] \to G^\alpha_\alpha : \C^\op \]

\subsection{Can I Get The Twisted Arrow Category Involved}

Ok, there's the category $\A$, and then there's $\T\A$, whose objects are morphisms
of $\A$ and whose morphisms are ways of picking out subcomposites.

One generalization of being a positive end --- which I'm hoping will turn out to be
 actually no more general --- is to be a natural transformation
\[M : G \o U \to F \o U : \T \A \to \C\]
where $U : \T \A \to {}^{\A^\op}_{\x \A}$. Naturality means that for any

\[
t : s \to f \quad = \quad
\begin{tikzcd}
  d'\ar[r, "s"]\ar[d, "i"'] &e' \ar[from=d, "o"']\\
  d\ar[r, "f"'] &e
\end{tikzcd} \quad \in \quad \T \A
\]
we should have commutativity of
\[
\begin{tikzcd}
  GUs \ar[r, "GUt"]\ar[d, "M_s"'] & GUf \ar[d, "M_f"]\\
  FUs\ar[r, "FUt"'] &FUf
\end{tikzcd}
\]
which would mean
\[
\begin{tikzcd}
  G^{e'}_{d'} \ar[r, "G^o_i"]\ar[d, "M_s"'] & G^e_d \ar[d, "M_f"]\\
  F^{e'}_{d'}\ar[r, "F^o_i"'] &F^e_d
\end{tikzcd}
\]
and taking $t = \ltri f$
\[
\ltri f : f \to d \quad = \quad
\begin{tikzcd}
  d\ar[r, "f"]\ar[d, equal] &e \ar[from=d, "f"']\\
  d\ar[r, equal] &d
\end{tikzcd} \quad \in \quad \T \A
\]
I get the familiar
\[
\begin{tikzcd}
  G^{e}_{d} \ar[r, "G^f"]\ar[d, "M_f"'] & G^d_d \ar[d, "M_d"]\\
  F^{e}_{d}\ar[r, "F^f"'] &F^d_d
\end{tikzcd}
\]

{\bf Question}: If I have a positive end in the usual sense, do I get a natural
transformation $GU \to FU$? It's not actually clear to me that I do, now.
I'd want to check naturality, and the equations I do get from a positive
end only seem to work if I get back to the diagonal.

\subsection{A Slightly Different Category}

Oh, I could just define a category $\ii \A$ (the `identity twisted-arrow category of $\A$')
to be
the wide subcategory of $\T\A$ where I only take the morphisms that go down to identity objects.
Then a positive end as I defined it before
is exactly a natural transformation $GU \to FU : \ii \A \to \C$.

I still don't know whether the $\ii$-based or $\T$-based definition is actually the `right' one,
more broadly. I bet a lot of my proofs so far don't depend on the exact selection of arrows.

\subsection{What are negative ends, then?}

Oh, I could say that $\ii^+ \A$ is where there are morphisms from arrow-objects to their
domain and codomain, and $\ii^- \A$ is where there are morphisms from the domain-and-codomain
to the arrow-object.

Let $U^- : \ii^- \A \to {}^{\A^\op}_{\x \A}$ and
$U^+ : \ii^+ \A \to {}^{\A^\op}_{\x \A}$ be the only sensible functors of their type.

They behave like
\[ U^+\left( \begin{tikzcd}
  d\ar[r, "f"]\ar[d, equal] &e \ar[from=d, "f"']\\
  d\ar[r, equal] &d
\end{tikzcd}
 \quad \in \quad \ii^+ \A[f, \rid_d]\right) =
\begin{tikzcd}
  \textcolor{red}d\ar[d, equal] &\textcolor{red} e \ar[from=d, "f"']\\
\textcolor{blue}  d &\textcolor{blue}d
\end{tikzcd}\quad : \textcolor{red}{\quad{}^e_d} \to \textcolor{blue}{{}^d_d}
\]
\[ U^+\left( \begin{tikzcd}
  d\ar[r, "f"]\ar[d, "f"'] &e \ar[from=d, equal]\\
  e\ar[r, equal] &e
\end{tikzcd}
 \quad \in \quad \ii^+ \A[f, \rid_e]\right) =
\begin{tikzcd}
  \textcolor{red}d\ar[d, "f"'] &\textcolor{red} e \ar[from=d, equal]\\
\textcolor{blue}  d &\textcolor{blue}d
\end{tikzcd}\quad : \textcolor{red}{\quad{}^e_d} \to \textcolor{blue}{{}^d_d}
\]

\[ U^-\left( \begin{tikzcd}
  d\ar[r, "f"]\ar[d, equal] &e \ar[from=d, "f"']\\
  d\ar[r, equal] &d
\end{tikzcd}
 \quad \in \quad \ii^- \A[ \rid_d, f]\right) =
\begin{tikzcd}
  \textcolor{red}d\ar[d, equal] &\textcolor{red} e \ar[from=d, "f"']\\
\textcolor{blue}  d &\textcolor{blue}d
\end{tikzcd}\quad : \textcolor{blue}{\quad{}^d_d} \to \textcolor{red}{{}^d_e}
\]

\[ U^-\left(\begin{tikzcd}
  d\ar[r, "f"]\ar[d, "f"'] &e \ar[from=d, equal]\\
  e\ar[r, equal] &e
\end{tikzcd}
 \quad \in \quad \ii^- \A[ \rid_e, f]\right) =
\begin{tikzcd}
  \textcolor{red}d\ar[d, "f"'] &\textcolor{red} e \ar[from=d, equal]\\
\textcolor{blue}  d &\textcolor{blue}d
\end{tikzcd}\quad : \textcolor{blue}{\quad{}^d_d} \to \textcolor{red}{{}^d_e}
\]

Then a negative end $\int [F] \to G$
is a natural transformation $FU^- \to GU^- : \ii^- \A \to \C$,
and a positive end $\int F \to [G]$
is a natural transformation $FU^+ \to GU^+ : \ii^+ \A \to \C$.

It is the case that $(\ii^+)^\op = \ii^-$ and $(U^+)^\op = {\sim} \o U^-$
where $\sim$ is the swap of the two components of a product.
\subsection{Trying Out Proofs with that Definition}

\[
\erule
{\Gamma \prov [P] \qquad \Gamma [N] \prov Q}
{\Gamma [P \lol N] \prov Q}
\]
So we want to achieve
\[\erule{
M : \Gamma U^+ \to P U^+
\qquad
K : (N U^-) \to (\Gamma \to Q)(U^-)
}
{
L :  (P \to N)(U^-) \to (\Gamma \to Q)(U^-)
}\]
i.e. we want to let an object of $t : \ii^- \C$ be given and make an arrow
\[(P \to N)(U^- t) \to (\Gamma \to Q)(U^- t)\]

Hmm... let's abstract a little. Instead of $\C \x \C^\op$, let's just suppose we have
a $\D$ with an overbar involution $\D^\op \to \D$. Then for functors $F, G : \D \to \rset$,
we define $F \to G : \D \to \rset$ by
\[ (F \to G)(D) = F\bar D \to GD\]
\[ (F \to G)(f : C \to D) = (F \bar C \to G C) \to (F \bar D \to G D)\]
\[ (F \to G)(f : C \to D) = \lambda m  . G f \o m \o F \bar f \]
Now if we have some other category, call it $\ii$, and functors $V: \ii \to \D$,
and you define $U : \ii^\op \to \D$ by $U(i) = \overline{V^\op(i)}$,
 and you have functors $\Gamma, P, N, Q : \D \to \rset$, then we're trying
to validate the rule
\[\erule{
M : \Gamma \o U \dto P\o U
\qquad
K : (N \o V) \dto (\Gamma \to Q) \o V
}
{
L :  (P \to N) \o V \dto (\Gamma \to Q) \o V
}\]
i.e.
\[\erule{
M : \lambda i . \Gamma \overline{V^\op(i)} \dto P \overline{V^\op(i)}
\qquad
K : \lambda i . NV(i) \dto (\Gamma \overline {V(i)} \to QV(i) )
}
{
L :  \lambda i .  (P{\overline {V(i)}} \to NV(i) )\dto
(\Gamma{\overline {V(i)}} \to QV(i) )
}\]
We define the object part
\[L_i (w, g) = K_i(w(M_i g), g)  \]
Naturality for $M$ and $K$ says that for any morphism $f : i \to j \in \ii$
we have
\[
\begin{tikzcd}
  \Gamma \overline{V^\op (j)} \ar[r, "\Gamma \overline{V^\op f}"]\ar[d, "M_j"']
&   \Gamma \overline{V^\op (i)}
\ar[d, "M_i"]
\\
  P \overline{V^\op (j)} \ar[r, "P \overline{V^\op f}"']
&   P \overline{V^\op (i)}
\end{tikzcd}
\qquad
\begin{tikzcd}
  N {V (i)} \ar[r, "N {V f}"]\ar[d, "K_i"']
&[3em]   N {V (j)}
\ar[d, "K_j"]
\\
  (\Gamma \to Q) {V (i)} \ar[r, "(\Gamma \to Q) {V f}"']
&   (\Gamma \to Q) {V (j)}
\end{tikzcd}
\]
and we want to check
\[
\begin{tikzcd}
  (P \to N) {V (i)} \ar[r, "(P \to N) {V f}"]\ar[d, "L_i"']
&[3em]   (P \to N) {V (j)}
\ar[d, "L_j"]
\\
  (\Gamma \to Q) {V (i)} \ar[r, "(\Gamma \to Q) {V f}"']
&   (\Gamma \to Q) {V (j)}
\end{tikzcd}
\]
So we calculate, for any $z \in (P{\overline {V(i)}} \to NV(i) )$
\[ L_j ((P\to N)V f) z = L_j (P \overline {V f} \to N V f) z \]
\[ = L_j (P \overline {V f} \to N V f) z \]
\[ = L_j (  \lambda q . N V f z \o q \o P \overline {V f} \bar z )\]
\[= \lambda g .  K_j( N V f z \o M_j g \o P \overline {V f} \bar z, g)  \]
ach this is too much of a mess for me to see what's going on.

\section{Returning To Multiple Variables}

Somehow I keep thinking that the situation I had before in \S\ref{two.variables}
with
\[
\erule
{\alpha : \A; [[t/\beta] F] \prov G \qquad \alpha : \A \prov t : \B}
{\alpha : \A;  [\forall (\beta:\B) . F]\prov G}
\]
\[ F : {}^{\A^\op}_{\x \A} \x {}^{\B^\op}_{\x \B} \to \rset\]
\[ G :  {}^{\A^\op}_{\x \A} \to \rset\]
\[ t :  {}^{\A^\op}_{\x \A} \to \B\]
I should only actually be demanding that I have negative super-end-like properties with
respect to $\B$ --- or at least, with respect to the stuff that goes through $t$ ---
 not with respect to the rest of the variables in $\A$. Like, I should assume
instead something weaker than
claiming that the proof $\alpha : \A; [[t/\beta] F] \prov G$ has
for every morphism $f : d \to e \in \A$, a map
\[ M_f : F^{dt^e_d}_{et^d_e} \to G^d_e \]
such that
\[
\begin{tikzcd}
  F^{d t^d_d}_{dt^d_d} \ar[r, "F^{t^f}_{ft_f}"]\ar[d, "M_d"']
& F^{d t^e_d}_{et^d_e} \ar[d, "M_f"]
& \ar[l]\ar[d, "M_e"] F^{e t^e_e}_{et^e_e}\\
  G^d_d \ar[r] & G^d_e & \ar[l] G^e_e
\end{tikzcd}
\]
The sort  of a proposition that I think should be provable is something
where I needn't act like I'm focused on or instantiating the variable of type $\A$.
If I have a mere end $\forall \alpha .  F^\alpha_{\alpha t} \to G^\alpha_\alpha$ then I should be able
to infer
$\forall \alpha . (\forall \beta. F^\alpha_{\alpha \beta}) \to G^\alpha_\alpha$
even though $\alpha$ is used bivariantly in $F$.

The proof tree should look something like
\[
\erule
{\[
\[
\[
\justifies
 F^\alpha_{\alpha t} \prov G^\alpha_\alpha
\]
\using blur \justifies
\beta.[ F^\alpha_{\alpha\beta}]^t \prov G^\alpha_\alpha
\]
\justifies
[\forall \beta . F^\alpha_{\alpha\beta}] \prov G^\alpha_\alpha
\]}
{\forall \beta . F^\alpha_{\alpha\beta} \prov G^\alpha_\alpha}
\]

So it's like there's a local context attached to the focus position, I guess?
The left focus judgment is
\[\Delta; \Gamma  [N]_\Omega^\theta \prov Q \]
where $\Omega$ is actually the same kind of context as $\Delta$, which contains
variables that are bound in $N$, and $\theta$
is a term-for-category-variable substitution, with $\Delta \prov \theta : \Omega$.
The invariant on $N$ being that
\[\Delta, \Omega \prov N : \rtype \]
The left rules for focus, blur, and $\forall$ would be
\[
\erule
{\Delta; \Gamma  [N]^\cdot_\cdot \prov Q }
{\Delta; \Gamma, N \prov Q }
\qquad
\erule
{\Delta; \Gamma, \theta P \prov Q \qquad   \Delta, \Omega^\pm \prov P}
{\Delta; \Gamma  [\ups P]^\theta_\Omega \prov Q }
\qquad
\erule
{\Delta; \Gamma [N]^{\theta[t/\alpha]}_\Omega \prov Q }
{\Delta; \Gamma  [\forall \alpha . N]^\theta_\Omega \prov Q }
\]
And now I have to understand what $\Delta; \Gamma  [N]_\Omega^\theta \prov Q $
actually means. It seems clear enough that I can pretend that $\Delta, \Omega$
are just simple categories, at least; when they're composite, it must be a product.
The semantics of $\theta$ is just a multiple-argument version of
whatever the semantics of a category term $t$ is,
coming from a product category (or a doubled product category) down to the category
$\Omega$.

My first guess is I see $\Delta;[N]^\theta_\Omega \prov Q$ as meaning, for every
object $d \in \Delta$ and every morphism $f : p \to q \in \Omega$,
I have $M_{df} : N^{d\theta^d_d}_{d\theta^d_d} \to Q^d_d$? This doesn't seem to fully use $f$.
Do I get like two distinct
$M^f : N^{d\theta^e_d}_{d\theta^d_e} \to Q^d_d$ and
$M_f : N^{e\theta^e_d}_{e\theta^d_e} \to Q^e_e$?
Before I go any farther with the awful nested subscripts, I need to remember that I can
define
\[(\theta F)^d_e = F^{d\theta^e_d}_{e\theta^d_e}\]
but, no, I want to decouple things away from that definition possibly. Maybe if I define
\[\theta^d_e F^{d'}_{e'} = F^{d'\theta^e_d}_{e'\theta^d_e}\]
Then my very tentative guess is that for a left-focused end I ask for
\[ M^f : \theta^d_e N^d_d  \to Q^d_d\]
\[ M_f : \theta^d_e N^e_e  \to Q^e_e\]
and then some diagrams I could consider asking for are
\[
\begin{tikzcd}
  \theta^d_d N^d_d \ar[r]\ar[d, "M^d"']&  \theta^d_e N^d_d
\ar[d, "M^f"]\ar[from=r, "/"{anchor=center}]&  \theta^e_e N^e_e \\
  Q^d_d \ar[r, equal]&   Q^d_d \ar[from=r, "/"{anchor=center}]& Q^e_e
\end{tikzcd}
\]
Oof that's ugly. What again is the way of phrasing ordinary ends in terms of morphisms?
Or is that even what I want? Shouldn't I be able to just talk about wrapping the
ordinary end around the focused end? Like
\[
\erule
{\int_{d \in \Delta} \int_{\beta \in \B} [A] \to (\Gamma \to Q)}
{\int_{d \in \Delta} \left[\int_{\beta \in \B} A\right] \to (\Gamma \to Q)}
\]
Is it actually about the variance of the variables that get used to build the term $t$?
Is it legit to do
\[
\erule
{ \int_\alpha F^{\alpha}_{\alpha\alpha} \to G^\alpha_\alpha}
{\int_{\alpha} \left(\int_{\beta} F^\alpha_{\alpha\beta}\right) \to G^\alpha_\alpha}
\]
In the special case where $F$ doesn't use its first two arguments, this reduces to
\[
\erule
{ \int_\alpha F_\alpha \to G^\alpha_\alpha}
{\int_{\alpha} \left(\int_{\beta} F_{\beta}\right) \to G^\alpha_\alpha}
\]
which I know is ok because $F$ is covariant. But I'm not yet sure about the more general version.

\subsection{A Variation on $\forall$L}
Let's try to validate
\[
\erule
{ \int_\alpha F^{\alpha}_{\alpha\alpha} \to G^\alpha_\alpha}
{\int_{\alpha} \left(\int_{\beta} F^\alpha_{\alpha\beta}\right) \to G^\alpha_\alpha}
\]
manually, then, I guess? Suppose I have
$M_d : F^d_{dd} \to G^d_d$
with
\[G_{f} \o M_d \o F^f = G^f \o M_e \o F_{ff} : F^e_{dd} \to G^d_e \eqno(*)\]
I try to make $P_d : \left(\int_\beta F^d_{d\beta}\right) \to G^d_d$ with
\[G_{f} \o P_d \o \left(\int_\beta F^f_{\cdot\beta}\right)
= G^f \o P_e \o \left(\int_\beta F_{f\beta}\right)
: \left(\int_\beta F^e_{d\beta}\right) \to G^d_e \]
So I define
\[ P_d = \lambda w . M_d(w_d) \]
and knowing $(*)$ I try to check
\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  P_d \left(\int_\beta F^f_{\cdot\beta}\right) (z)
= G^f  P_e  \left(\int_\beta F_{f\beta}\right) (z)
:   G^d_e \]
i.e.
\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  M_d \left(\left(\int_\beta F^f_{\cdot\beta}\right) (z)\right)_d
= G^f  M_e  \left(\left(\int_\beta F_{f\beta}\right) (z)\right)_e
:   G^d_e \]

Now let's think about $z$. Its end property is
\[F^e_{df} z_d = z_e\]

How does transport inside ends look? Surely
\[\left(\int_\beta F^f_{\cdot\beta}\right) (z) = \Lambda d . F^f_{\cdot d} z_d \]
and the like, so we're really checking

\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  M_d  F^f_{\cdot d} (z_d)
= G^f  M_e   F_{f e} (z_e)
:   G^d_e \]
Now using $z$'s end property we have
\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  M_d  F^f_{\cdot d} (z_d)
= G^f  M_e   F_{f e} (F_{\cdot f} z_d)
:   G^d_e \]
and now this follows directly from $M$'s end-property.

\subsection{Redo with a term}
I expect this will be boring and similar to the above case,
 but let's do it anyway. Suppose we have a
functor $t : {}^{\A^\op}_{\x \A} \to \B$. Let's try to validate
\[
\erule
{ \int_\alpha F^{\alpha}_{\alpha t^\alpha_\alpha} \to G^\alpha_\alpha}
{\int_{\alpha \in \A} \left(\int_{\beta \in \B} F^\alpha_{\alpha\beta}\right) \to G^\alpha_\alpha}
\]
So we have
$M_d : F^d_{dt^d_d} \to G^d_d$
with
\[G_{f} \o M_d \o F^f_{\bullet t^f_\bullet} = G^f \o M_e \o F^\bullet_{ft^\bullet_f} : F^e_{dt^e_d} \to G^d_e \eqno(*)\]
I try to make $P_d : \left(\int_\beta F^d_{d\beta}\right) \to G^d_d$ with
\[G_{f} \o P_d \o \left(\int F^f_{\bullet\bullet}\right)
= G^f \o P_e \o \left(\int F^\bullet_{f\bullet}\right)
: \left(\int_\beta F^e_{d\beta}\right) \to G^d_e \]
So I define
\[ P_d = \lambda w . M_d(w_{t^d_d}) \]
and knowing $(*)$ I try to check
\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  P_d \left(\int F^f_{\bullet\bullet}\right) (z)
= G^f  P_e  \left(\int F^\bullet_{f\bullet}\right) (z)
:   G^d_e \]
i.e.
\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  M_d  F^f_{\bullet\bullet} z_{t^d_d}
= G^f  M_e   F^\bullet_{f\bullet} z_{t^e_e}
:   G^d_e \]
Now $z$'s end property is still
\[F^\bullet_{\bullet \phi} z_\delta  = z_\epsilon\]
for any morphism $\phi : \delta  \to \epsilon \in \B$. We can't find any morphisms
directly between $t^d_d$ and $t^e_e$, but we {\em can} find a pair of morphisms
that start from a common object in $\B$ and end up at them respectively.
Does that help us? We consider
\[t^f_\bullet : t^e_d \to t^d_d \qquad t_f^\bullet : t^e_d \to t^e_e\]
and plugging that into $z$'s end property gives us
\[F^{\bullet}_{ \bullet t^f_\bullet} z_{ t^e_d}  = z_{t^d_d}\qquad
F^{\bullet}_{ \bullet t_f^\bullet} z_{ t^e_d}  = z_{t^e_e}\]
So our proof obligation is now
\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  M_d  F^f_{\bullet\bullet} F^{\bullet}_{ \bullet t^f_\bullet} z_{ t^e_d}
= G^f  M_e   F^\bullet_{f\bullet} F^{\bullet}_{ \bullet t_f^\bullet} z_{ t^e_d}
:   G^d_e \]
in other words
\[\left(z : \int_\beta F^e_{d\beta}\right) \to
G_{f}  M_d  F^f_{\bullet t^f_\bullet}  z_{ t^e_d}
= G^f  M_e   F^\bullet_{ft_f^\bullet}  z_{ t^e_d}
:   G^d_e \]
which is immediately satisfied by $(*)$! That was actually a closer call than I thought.
\end{document}
